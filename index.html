<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกประวัติการรักษาพยาบาล - ห้องพยาบาลการบินกรุงเทพฯ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f0f9ff;
        }

        .bg-turquoise {
            background-color: #40E0D0;
        }

        .bg-turquoise-light {
            background-color: #AFEEEE;
        }

        .text-turquoise {
            color: #40E0D0;
        }

        .border-turquoise {
            border-color: #40E0D0;
        }

        .bg-navy {
            background-color: #0A2463;
        }

        .text-navy {
            color: #0A2463;
        }

        .bg-primary {
            --tw-bg-opacity: 1;
            background-color: rgb(0 163 184 / var(--tw-bg-opacity, 1));
        }
        .btn-danger {
            color: #fff;
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-primary {
            background-color: #0A2463;
            color: white;
            transition: all 0.3s;
        }

            .btn-primary:hover {
                background-color: #153a94;
            }

        .btn-secondary {
            background-color: #40E0D0;
            color: #0A2463;
            transition: all 0.3s;
        }

            .btn-secondary:hover {
                background-color: #2ec4b6;
            }

        .form-input:focus {
            border-color: #40E0D0;
            box-shadow: 0 0 0 3px rgba(64, 224, 208, 0.3);
        }

        .tab {
            cursor: pointer;
            transition: all 0.3s;
        }

            .tab.active {
                background-color: #40E0D0;
                color: #0A2463;
                font-weight: 500;
            }

            .tab:hover:not(.active) {
                background-color: #AFEEEE;
            }

        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .loader {
            border-top-color: #40E0D0;
            border-right-color: #40E0D0;
            border-bottom-color: #40E0D0;
            border-left-color: transparent;
            animation: spin 1s linear infinite;
        }

        .choices__placeholder {
            opacity: 1;
        }
        .choices__inner {
            display: inline-block;
            vertical-align: top;
            width: 100%;
            background-color: #ffffff;
            padding: 7.5px 7.5px 3.75px;
            border: 1px solid #ddd;
            border-radius: 2.5px;
            font-size: 14px;
            min-height: 44px;
            overflow: hidden;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-navy text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    <div>
                        <h1 class="text-xl font-bold">ห้องพยาบาลการบินกรุงเทพฯ</h1>
                        <button onclick="changeLocation()"><p id="location" class="text-xs text-turquoise">สำนักงานใหญ่</p></button>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="text-right">
                        <p id="fname" class="font-medium">
                            เจ้าหน้าที่พยาบาล
                        </p>

                        <p class="text-xs text-turquoise">ระบบบันทึกประวัติการรักษา</p>
                    </div>
                    <button id="logoutBtn" onclick="logout()" style="margin-left:10px" class="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1 rounded-md flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        ออกจากระบบ
                    </button>
                </div>
            </div>
        </header>
        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-6">
            <div id="auth-section" class="fixed inset-0 bg-black bg-opacity-50  items-center flex  justify-center z-50">
                <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
					<!--
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Login</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input id="email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex space-x-4">
                        <button onclick="login()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">Login</button>
                    </div>
					-->
					   <div class="flex space-x-4">
                        <button onclick="googleLogin()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">Sign in with Google</button>
                    </div>
                </div>
            </div>
            <div id="location-section" class="fixed hidden inset-0 bg-black bg-opacity-50  items-center flex  justify-center z-50">
                <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Location</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                        <select id="locationSel" name="locationSel" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                            <option disabled selected>-- เลือก --</option>
                        </select>
                    </div>

                    <div class="flex space-x-4">
                        <button onclick="saveLocation()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition">Yes</button>
                        <button onclick="document.getElementById('location-section').classList.add('hidden');" class="flex-1 bg-yellow-600 text-white py-2 px-4 rounded-lg hover:bg-yellow-700 transition">No</button>
                    </div>
                </div>
            </div>
            <!-- Dashboard -->
            <div id="dashboard" class="hidden">
                <!-- Tabs -->
                <div class="flex border-b border-gray-200 mb-6">
                    <div class="tab active px-4 py-2 rounded-t-lg" data-tab="newRecord">ค้นหาประวัติ</div>
                    <div class="tab px-4 py-2 rounded-t-lg" data-tab="searchRecord">การรักษา</div>
                    <div class="tab px-4 py-2 rounded-t-lg" data-tab="reports">รายงาน</div>
                </div>
                <!-- New Record Form -->
                <div id="newRecord" class="tab-content ">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8" style="padding-bottom:0px;margin-bottom:20px;">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-1">

                            <div class="mb-3">
                                <div class="relative flex-grow flex">
                                    <input id="searchInput" type="text" placeholder="ค้นหาข้อมูล..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                    </svg>
                                    <button id="searchBtn" class="btn-primary text-white px-4 py-2 rounded-r-md hover:btn-primary/90 focus:outline-none focus:ring-2 focus:ring-primary">
                                        ค้นหา
                                    </button>

                                </div>
                                <button type="button" id="searchEmployeeBtn" class="mt-1 hidden text-sm text-turquoise hover:underline">เพิ่มผู้ป่วยใหม่</button>
                                <button type="button" id="newCustomerBtn" class="mt-1  text-sm text-turquoise hover:underline">เพิ่มผู้ป่วยใหม่</button>

                            </div>
                            <!--
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="employeeId">
                                    รหัสพนักงาน <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="employeeId" name="employeeId" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                                <button type="button" id="searchEmployeeBtn" class="mt-1 hidden text-sm text-turquoise hover:underline">ค้นหาข้อมูลพนักงาน</button>
                                <button type="button" id="searchBtn" class="mt-1 text-sm text-turquoise hover:underline">ค้นหาข้อมูลพนักงาน</button>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="firstName">
                                        ชื่อ <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="firstName" name="firstName" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="lastName">
                                        นามสกุล <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="lastName" name="lastName" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                                </div>
                            </div>
                                -->
                        </div>
                    </div>

                    <div id="customer-insert" class="bg-white hidden rounded-xl shadow-lg p-6 mb-8" style="padding-bottom:0px;margin-bottom:20px;">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-1">
                            <h3 class="text-lg font-medium text-navy mb-3">ข้อมูลพนักงาน</h3>
                            <div class="mb-3"></div>
                            <div class="grid grid-cols-2 gap-1">
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="employeeId1">
                                        รหัสพนักงาน <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="employeeId1" name="employeeId1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="department1">
                                        แผนก 
                                    </label>
                                    <input type="text" id="department1" name="department1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-1">
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="birthdate">วันเดือนปีเกิด</label>
                                    <input type="date" id="birthdate1" name="birthdate1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none">
                                </div>
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="phone">เบอร์โทรศัพท์</label>
                                    <input type="tel" id="phone1" name="phone1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none">
                                </div>
                            </div>
                            <!--
    <div class="grid grid-cols-2 gap-3 mb-3">
        <div>
            <label class="block text-gray-700 text-sm font-medium mb-1" for="firstName1">
                ชื่อ <span class="text-red-500">*</span>
            </label>
            <input type="text" id="firstName1" name="firstName1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
        </div>
        <div>
            <label class="block text-gray-700 text-sm font-medium mb-1" for="lastName1">
                นามสกุล <span class="text-red-500">*</span>
            </label>
            <input type="text" id="lastName1" name="lastName1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
        </div>
    </div>
    -->
                        </div>
                        <!--
                        <div class="grid grid-cols-2 gap-1">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="department1">
                                    แผนก <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="department1" name="department1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                            </div>
                            <div class="grid grid-cols-2 gap-1">
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="birthdate">วันเดือนปีเกิด</label>
                                    <input type="date" id="birthdate1" name="birthdate1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none">
                                </div>
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="phone">เบอร์โทรศัพท์</label>
                                    <input type="tel" id="phone1" name="phone1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none">
                                </div>
                            </div>
                        </div>
                            -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-1">
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="congenitalDisease">โรคประจำตัว</label>
                                <textarea id="congenitalDisease1" name="congenitalDisease1" rows="1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="allergies">แพ้ยา/แพ้อาหาร</label>
                                <textarea id="allergies1" name="allergies1" rows="1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none"></textarea>
                            </div>
                        </div>
                        <div class="flex justify-center">
                            <button id="saveCustomerBtn" class="btn-primary px-6 py-2 rounded-md">บันทึกข้อมูล</button>
                        </div>
                        <br />
                    </div>

                    <div id="customer-result" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <div id="searchResults">
                            <p class="text-gray-500 text-center">กรุณาระบุข้อมูลที่ต้องการค้นหา</p>
                        </div>
                        <div id="recordDetail" class="hidden mt-8 border-t pt-6">
                            <h3 class="text-lg font-medium text-navy mb-4">รายละเอียดประวัติการรักษา</h3>
                            <div id="recordDetailContent"></div>
                        </div>
                    </div>
                </div>
                <!-- Search Record -->
                <div id="searchRecord" class="tab-content hidden ">
                    <!--
                    <h2 class="text-xl font-bold text-navy mb-4">ค้นหาประวัติการรักษา</h2>
                    <div class="mb-6">
                        <div class="flex space-x-4">
                            <div class="flex-grow">
                                <input type="text" id="searchInput" class="form-input w-full px-4 py-2 border rounded-md focus:outline-none" placeholder="ค้นหาด้วยรหัสพนักงาน, ชื่อ หรือนามสกุล">
                            </div>
                            <button id="searchBtn" class="btn-primary px-6 py-2 rounded-md">ค้นหา</button>
                        </div>
                    </div>
                    <br />-->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-1">
                            <h3 class="text-lg font-medium text-navy mb-3">ข้อมูลพนักงาน</h3>
                            <div class="mb-3"></div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="employeeId2 ">
                                    รหัสพนักงาน <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="employeeId2" name="employeeId2" disabled class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                            </div>
                            <!--
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="firstName2">
                                        ชื่อ <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="firstName2" name="firstName2" disabled class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="lastName2">
                                        นามสกุล <span class="text-red-500">*</span>
                                    </label>
                                    <input type="text" id="lastName2" name="lastName2" disabled class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                                </div>
                            </div>

                            -->
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-1">
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="congenitalDisease2">โรคประจำตัว</label>
                                <textarea id="congenitalDisease2" name="congenitalDisease2" disabled rows="1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="allergies2">แพ้ยา/แพ้อาหาร</label>
                                <textarea id="allergies2" name="allergies2" disabled rows="1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none"></textarea>
                            </div>
                        </div>

                    </div>
                    <div class=" bg-white rounded-xl shadow-lg p-6 mb-8">
                        <form id="medicalRecordForm">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-1">
                                <h3 class="text-lg font-medium text-navy mb-3">ข้อมูลการรักษา</h3>
                                <div class="mb-3"></div>
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="visitDate2">
                                        วันที่รับบริการ <span class="text-red-500">*</span>
                                    </label>
                                    <input type="datetime-local" id="visitDate2" name="visitDate2" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="esiTriage2">
                                        ESI Triage <span class="text-red-500">*</span>
                                    </label>
                                    <select id="esiTriage2" name="esiTriage2" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                                        <option value="">-- เลือก --</option>
                                        <option value="1 - ต้องได้รับการรักษาทันที">1 - ต้องได้รับการรักษาทันที</option>
                                        <option value="2 - ภาวะฉุกเฉินมาก">2 - ภาวะฉุกเฉินมาก</option>
                                        <option value="3 - ภาวะฉุกเฉิน">3 - ภาวะฉุกเฉิน</option>
                                        <option value="4 - ภาวะกึ่งฉุกเฉิน">4 - ภาวะกึ่งฉุกเฉิน</option>
                                        <option value="5 - ภาวะไม่ฉุกเฉิน">5 - ภาวะไม่ฉุกเฉิน</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-medium mb-1">Vital Signs</label>
                                <div class="grid grid-cols-5 gap-1">
                                    <div>
                                        <label class="block text-gray-700 text-xs mb-1" for="temperature2">อุณหภูมิ (°C)</label>
                                        <input type="number" step="0.1" id="temperature2" name="temperature2" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" placeholder="36.5">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 text-xs mb-1" for="pulse2">ชีพจร (ครั้ง/นาที)</label>
                                        <input type="number" id="pulse2" name="pulse2" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" placeholder="80">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 text-xs mb-1" for="respiration2">การหายใจ (ครั้ง/นาที)</label>
                                        <input type="number" id="respiration2" name="respiration2" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" placeholder="16">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 text-xs mb-1" for="bloodPressure2">ความดันโลหิต (mmHg)</label>
                                        <input type="text" id="bloodPressure2" name="bloodPressure2" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" placeholder="120/80">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 text-xs mb-1" for="oxygenSaturation2">SpO2 (%)</label>
                                        <input type="number" id="oxygenSaturation2" name="oxygenSaturation2" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" placeholder="98">
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-1">
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="chiefComplaint2">
                                        อาการสำคัญ <span class="text-red-500">*</span>
                                    </label>
                                    <textarea id="chiefComplaint2" name="chiefComplaint2" rows="2" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="physicalExamination2">การตรวจร่างกาย</label>
                                    <textarea id="physicalExamination2" name="physicalExamination2" rows="2" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="diagnosis2">การวินิจฉัย</label>
                                    <select id="diagnosis2" name="diagnosis2" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                                        <option value="">-- เลือก --</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="advice2">คำแนะนำ</label>
                                    <textarea id="advice2" name="advice2" rows="2" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1">การนัดติดตามอาการ</label>
                                    <div class="flex items-center space-x-4">
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="followUp2" value="Y" class="form-radio text-turquoise">
                                            <span class="ml-2">มี</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="radio" name="followUp2" value="N" class="form-radio text-turquoise" checked>
                                            <span class="ml-2">ไม่มี</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="block text-gray-700 text-sm font-medium mb-1" for="serviceType">
                                        ประเภทการให้บริการ <span class="text-red-500">*</span>
                                    </label>
                                    <select id="serviceType2" name="serviceType2" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                                        <option value="">-- เลือก --</option>
                                        <option value="ปรึกษาพยาบาล">ปรึกษาพยาบาล</option>
                                        <option value="สั่งจ่ายยาด้วยตนเอง">สั่งจ่ายยาด้วยตนเอง</option>
                                        <option value="ใช้ห้องสังเกตอาการ">ใช้ห้องสังเกตอาการ</option>
                                        <option value="อุบัติเหตุ/ฉุกเฉิน">อุบัติเหตุ/ฉุกเฉิน</option>
                                        <option value="ส่งต่อ/แนะนำ">ส่งต่อ/แนะนำ</option>
                                        <!--
                                        <option value="consulted">ปรึกษาพยาบาล</option>
                                        <option value="selfMedication">สั่งจ่ายยาด้วยตนเอง</option>
                                        <option value="observeRoom">ใช้ห้องสังเกตอาการ</option>
                                        <option value="emergency">อุบัติเหตุ/ฉุกเฉิน</option>
                                        <option value="refer">ส่งต่อ/แนะนำ</option>
                                            -->
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-800">📋 รายการยา</h2>
                            <div class="mt-6 flex justify-start">
                                <button onclick="addMedicine()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200"> ➕ สั่งยา </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ลำดับ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อยา</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภท</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวน</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หน่วย</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หมายเหตุ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="medicineTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Sample data
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">1</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">พาราเซตามอล</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">ยาแก้ปวด</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">50</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">เม็ด</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">สำหรับแก้ปวดหัว</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editMedicine(0)" class="text-indigo-600 hover:text-indigo-900 mr-3">✏️ แก้ไข</button>
                        <button onclick="deleteMedicine(0)" class="text-red-600 hover:text-red-900">🗑️ ลบ</button>
                    </td>
                </tr>
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">2</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">แอสไพริน</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">ยาแก้ไข้</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">30</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">เม็ด</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">ลดไข้และแก้ปวด</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editMedicine(1)" class="text-indigo-600 hover:text-indigo-900 mr-3">✏️ แก้ไข</button>
                        <button onclick="deleteMedicine(1)" class="text-red-600 hover:text-red-900">🗑️ ลบ</button>
                    </td>
                </tr>
                    -->
                                </tbody>
                            </table>
                            <br />
                        </div>
                        <!-- Empty State -->
                        <div id="emptyState" class="hidden bg-white rounded-xl shadow-lg p-12 text-center">
                            <div class="text-6xl mb-4">💊</div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">ยังไม่มีรายการยา</h3>
                            <p class="text-gray-600">เริ่มต้นโดยการเพิ่มยาใหม่ด้านบน</p>
                        </div>
                    </div>
                    <br />
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="flex justify-center mt-6">
                            <button type="submit" id="saveOpdCardBtn" class="btn-primary px-6 py-2 rounded-md">บันทึกข้อมูล</button>
                            <button type="reset" id="clearOpdCardBtn" class="btn-secondary ml-4 px-6 py-2 rounded-md">ล้างข้อมูล</button>
                        </div>
                        <br />
                    </div>
                </div>
                <!-- Reports -->
                <div id="reports" class="tab-content hidden bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold text-navy mb-4">รายงาน</h2>
                    <div id="searchReport-sec" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1" for="reportType">ประเภทรายงาน</label>
                            <select id="reportType" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none">
                                <!--<option value="daily">รายงานประจำวัน</option>
    <option value="monthly">รายงานประจำเดือน</option>
        -->
                                <option value="serviceType">รายงานตามประเภทการให้บริการ</option>
                                <option value="department">รายงานตามแผนก</option>
                                <option value="diagnosis">รายงานตามการวินิฉัย</option>
                                <option value="medicine">รายงานตามการใช้ยา</option>
                            </select>
                        </div>
                        <div id="locationReport-sec" class="hidden">
                            <label class="block text-gray-700 text-sm font-medium mb-1" for="locationReport">Location</label>
                            <select id="locationReport" name="locationReport" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                                <option disabled selected>-- ทั้งหมด --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1" for="reportStartDate">วันที่เริ่มต้น</label>
                            <input type="date" id="reportStartDate" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1" for="reportEndDate">วันที่สิ้นสุด</label>
                            <input type="date" id="reportEndDate" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none">
                        </div>
                    </div>
                    <div class="flex justify-center mb-6">
                        <button id="generateReportBtn" class="btn-primary px-6 py-2 rounded-md">สร้างรายงาน</button>
                    </div>
                    <div id="reportResults" class="mt-4">
                        <p class="text-gray-500 text-center">กรุณาเลือกประเภทรายงานและช่วงเวลาที่ต้องการ</p>
                    </div>
                    <div class="mt-8">
                        <canvas id="reportChart" class="w-full h-64 hidden"></canvas>
                    </div>
                </div>
            </div>
        </main>
        <!-- Footer -->
        <footer class="bg-navy text-white py-4">
            <div class="container mx-auto px-4 text-center">
                <p>&copy; 2023 ห้องพยาบาลการบินกรุงเทพฯ สำนักงานใหญ่</p>
                <p class="text-xs text-turquoise mt-1">ระบบบันทึกประวัติการรักษาพยาบาล</p>
            </div>
        </footer>
    </div>
    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-xl bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">✏️ แก้ไขข้อมูลยา</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อยา</label>
                        <!--
                        <input type="text" id="editMedicineName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        -->
                        <select id="editMedicineName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ประเภท</label>
                        <select id="editMedicineType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="ยาแก้ปวด">ยาแก้ปวด</option>
                            <option value="ยาแก้ไข้">ยาแก้ไข้</option>
                            <option value="ยาปฏิชีวนะ">ยาปฏิชีวนะ</option>
                            <option value="ยาแก้แพ้">ยาแก้แพ้</option>
                            <option value="ยาวิตามิน">ยาวิตามิน</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">จำนวน</label>
                        <input type="number" id="editMedicineQuantity" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" min="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">หน่วย</label>
                        <select id="editMedicineUnit" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="เม็ด">เม็ด</option>
                            <option value="แคปซูล">แคปซูล</option>
                            <option value="ขวด">ขวด</option>
                            <option value="หลอด">หลอด</option>
                            <option value="ซอง">ซอง</option>
                            <option value="กล่อง">กล่อง</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">หมายเหตุ</label>
                    <input type="text" id="editMedicineNote" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeEditModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        ยกเลิก
                    </button>
                    <button onclick="saveEdit()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                        บันทึก
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-4 right-4 max-w-md bg-white rounded-lg shadow-lg p-4 transform transition-transform duration-300 scale-0 z-50">
        <div class="flex items-center">
            <div id="notificationIcon" class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3"></div>
            <div class="flex-grow">
                <h4 id="notificationTitle" class="font-medium"></h4>
                <p id="notificationMessage" class="text-sm text-gray-600"></p>
            </div>
            <button id="closeNotification" class="flex-shrink-0 ml-2 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>
    </div>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col items-center">
            <div class="loader w-12 h-12 border-4 rounded-full mb-4"></div>
            <p id="loadingMessage" class="text-gray-700">กำลังประมวลผล...</p>
        </div>
    </div>
    <script>
        // Sample data for demonstration
        const sampleData = {
            employees: {
                "E001": {
                    firstName: "สมชาย",
                    lastName: "ใจดี",
                    department: "ฝ่ายบริการลูกค้า",
                    birthdate: "1985-05-15",
                    phone: "0891234567",
                    congenitalDisease: "ความดันโลหิตสูง",
                    allergies: "แพ้ยาเพนนิซิลิน",
                    updatedAt: "2023-05-10T08:30:00.000Z"
                },
                "E002": {
                    firstName: "สมหญิง",
                    lastName: "รักเรียน",
                    department: "ฝ่ายบัญชี",
                    birthdate: "1990-10-20",
                    phone: "0872345678",
                    congenitalDisease: "",
                    allergies: "แพ้ถั่วลิสง",
                    updatedAt: "2023-05-12T10:15:00.000Z"
                },
                "E003": {
                    firstName: "วิชัย",
                    lastName: "สุขสบาย",
                    department: "ฝ่ายปฏิบัติการบิน",
                    birthdate: "1982-03-08",
                    phone: "0863456789",
                    congenitalDisease: "เบาหวาน",
                    allergies: "",
                    updatedAt: "2023-05-15T14:20:00.000Z"
                },
                "E004": {
                    firstName: "นภา",
                    lastName: "ฟ้าใส",
                    department: "ฝ่ายการตลาด",
                    birthdate: "1988-12-25",
                    phone: "0854567890",
                    congenitalDisease: "",
                    allergies: "",
                    updatedAt: "2023-05-18T09:45:00.000Z"
                },
                "E005": {
                    firstName: "ประสิทธิ์",
                    lastName: "มั่นคง",
                    department: "ฝ่ายซ่อมบำรุง",
                    birthdate: "1979-07-30",
                    phone: "0845678901",
                    congenitalDisease: "โรคหอบหืด",
                    allergies: "แพ้ฝุ่น",
                    updatedAt: "2023-05-20T11:30:00.000Z"
                }
            },
            medicalRecords: {
                "R001": {
                    id: "R001",
                    employeeId: "E001",
                    visitDate: "2023-05-10T08:30:00.000Z",
                    esiTriage: "3",
                    vitalSigns: {
                        temperature: "37.2",
                        pulse: "85",
                        respiration: "18",
                        bloodPressure: "140/90",
                        oxygenSaturation: "98"
                    },
                    chiefComplaint: "ปวดศีรษะ มีไข้เล็กน้อย",
                    physicalExamination: "ไม่พบความผิดปกติอื่น",
                    diagnosis: "ไข้หวัด",
                    treatment: "ให้ยาพาราเซตามอล 500 mg 1 เม็ด ทุก 6 ชั่วโมง",
                    advice: "พักผ่อนให้เพียงพอ ดื่มน้ำมากๆ",
                    followUp: "N",
                    serviceType: "selfMedication",
                    createdAt: "2023-05-10T08:45:00.000Z",
                    createdBy: "เจ้าหน้าที่พยาบาล"
                },
                "R002": {
                    id: "R002",
                    employeeId: "E002",
                    visitDate: "2023-05-12T10:15:00.000Z",
                    esiTriage: "4",
                    vitalSigns: {
                        temperature: "36.8",
                        pulse: "78",
                        respiration: "16",
                        bloodPressure: "120/80",
                        oxygenSaturation: "99"
                    },
                    chiefComplaint: "ปวดท้องประจำเดือน",
                    physicalExamination: "ไม่พบความผิดปกติ",
                    diagnosis: "อาการปวดประจำเดือน",
                    treatment: "ให้ยาพอนสแตน 500 mg 1 เม็ด ทุก 8 ชั่วโมง",
                    advice: "ประคบอุ่นบริเวณท้องน้อย",
                    followUp: "N",
                    serviceType: "consulted",
                    createdAt: "2023-05-12T10:30:00.000Z",
                    createdBy: "เจ้าหน้าที่พยาบาล"
                },
                "R003": {
                    id: "R003",
                    employeeId: "E003",
                    visitDate: "2023-05-15T14:20:00.000Z",
                    esiTriage: "2",
                    vitalSigns: {
                        temperature: "36.5",
                        pulse: "90",
                        respiration: "20",
                        bloodPressure: "130/85",
                        oxygenSaturation: "97"
                    },
                    chiefComplaint: "เวียนศีรษะ ตาลาย หน้ามืด",
                    physicalExamination: "ระดับน้ำตาลในเลือด 60 mg/dL",
                    diagnosis: "ภาวะน้ำตาลในเลือดต่ำ",
                    treatment: "ให้น้ำหวาน และอาหารว่าง ตรวจวัดระดับน้ำตาลซ้ำหลังรับประทาน 95 mg/dL",
                    advice: "รับประทานอาหารให้ตรงเวลา ไม่ควรงดมื้ออาหาร",
                    followUp: "Y",
                    serviceType: "observeRoom",
                    createdAt: "2023-05-15T15:00:00.000Z",
                    createdBy: "เจ้าหน้าที่พยาบาล"
                },
                "R004": {
                    id: "R004",
                    employeeId: "E004",
                    visitDate: "2023-05-18T09:45:00.000Z",
                    esiTriage: "5",
                    vitalSigns: {
                        temperature: "36.7",
                        pulse: "75",
                        respiration: "16",
                        bloodPressure: "110/70",
                        oxygenSaturation: "99"
                    },
                    chiefComplaint: "ขอคำปรึกษาเรื่องการดูแลสุขภาพ",
                    physicalExamination: "ร่างกายแข็งแรงดี",
                    diagnosis: "",
                    treatment: "",
                    advice: "แนะนำการออกกำลังกายและการรับประทานอาหารที่เหมาะสม",
                    followUp: "N",
                    serviceType: "consulted",
                    createdAt: "2023-05-18T10:00:00.000Z",
                    createdBy: "เจ้าหน้าที่พยาบาล"
                },
                "R005": {
                    id: "R005",
                    employeeId: "E005",
                    visitDate: "2023-05-20T11:30:00.000Z",
                    esiTriage: "3",
                    vitalSigns: {
                        temperature: "36.9",
                        pulse: "88",
                        respiration: "22",
                        bloodPressure: "125/85",
                        oxygenSaturation: "96"
                    },
                    chiefComplaint: "หายใจลำบาก มีเสียงหวีด",
                    physicalExamination: "ได้ยินเสียงวี้ดในปอด",
                    diagnosis: "หอบหืดกำเริบ",
                    treatment: "พ่นยาขยายหลอดลม Salbutamol 2 puff",
                    advice: "หลีกเลี่ยงสิ่งกระตุ้น เช่น ฝุ่น ควัน",
                    followUp: "Y",
                    serviceType: "emergency",
                    createdAt: "2023-05-20T12:00:00.000Z",
                    createdBy: "เจ้าหน้าที่พยาบาล"
                },
                "R006": {
                    id: "R006",
                    employeeId: "E001",
                    visitDate: "2023-05-25T13:15:00.000Z",
                    esiTriage: "4",
                    vitalSigns: {
                        temperature: "36.8",
                        pulse: "82",
                        respiration: "17",
                        bloodPressure: "135/85",
                        oxygenSaturation: "98"
                    },
                    chiefComplaint: "ปวดหลัง",
                    physicalExamination: "กดเจ็บบริเวณกล้ามเนื้อหลังส่วนล่าง",
                    diagnosis: "ปวดกล้ามเนื้อหลัง",
                    treatment: "ให้ยา Diclofenac 50 mg 1 เม็ด หลังอาหาร เช้า-เย็น",
                    advice: "ประคบอุ่น หลีกเลี่ยงการยกของหนัก",
                    followUp: "N",
                    serviceType: "selfMedication",
                    createdAt: "2023-05-25T13:30:00.000Z",
                    createdBy: "เจ้าหน้าที่พยาบาล"
                }
            },
            employeeMedicalRecords: {
                "E001": {
                    "R001": true,
                    "R006": true
                },
                "E002": {
                    "R002": true
                },
                "E003": {
                    "R003": true
                },
                "E004": {
                    "R004": true
                },
                "E005": {
                    "R005": true
                }
            }
        };

        const firebaseConfig = {
            apiKey: "AIzaSyC5WWSxG9iLQMZqO057qZ-Q4EA19d3Q1eE",
            authDomain: "pg-firstaid.firebaseapp.com",
            projectId: "pg-firstaid"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
		const functions = firebase.functions();
        var userDb;
        var customerDb;
		

        auth.onAuthStateChanged(async user => {
            /*const authSection = document.getElementById('auth-section');
            const appSection = document.getElementById('app-section');
            const status = document.getElementById('auth-status');*/
            if (user) {
                /*if (user.email != 'aa@aa.com'){
                  alert('Not permission.')
                  auth.signOut();
              }*/
                //status.textContent = "Logged in as " + user.email;
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                let snapshot = await db.collection("staff").where("email", "==", user.email).get();
                /*snapshot.forEach((doc) => {
                      // doc.data() is never undefined for query doc snapshots
                      console.log(doc.id, " => ", doc.data());
                });*/
				firebase.auth().currentUser.getIdTokenResult(true).then((result) => {
					//console.log("authTime:", result.authTime);
					//console.log("authTime (Date):", new Date(result.authTime));
					
					  const authTime = new Date(result.authTime);
					  const now = new Date();
					  const diffMinutes = (now.getTime() - authTime.getTime()) / 60000;

				      if (diffMinutes > 9 * 60){
						logout();
					  }
					  
					  //console.log("authTime:", authTime.toISOString());
					  //console.log("Now:", now.toISOString());
					  console.log("Diff (minutes):", diffMinutes);
					  
				  }) .catch((error) => {
					console.error("Error getting ID token result:", error);
			    });;
  
                if (snapshot.docs.length > 0) {
                    userDb = snapshot.docs[0];
                    let firstDoc = snapshot.docs[0];
                    let name = firstDoc.data().name;
                    let location = firstDoc.data().location;
                    document.getElementById("fname").innerText = name;
                    document.getElementById("location").innerText = location;
                    isAdmin = firstDoc.data().isAdmin;
                    if (isAdmin) {
                        let snapshot = await db.collection("location").get();

                        const select = document.getElementById("locationReport");

                        // ลบ option เดิมทั้งหมดก่อน (optional)
                        select.innerHTML = "";

                        // สร้าง option แรกที่เป็น "-- เลือก --"
                        const defaultOption = document.createElement("option");
                        defaultOption.textContent = "-- ทั้งหมด --";
                        defaultOption.value = '';        // หรือ "none"
                        defaultOption.disabled = false;
                        defaultOption.selected = true;

                        select.appendChild(defaultOption);

                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const option = document.createElement("option");
                            //option.value = doc.id;
                            option.value = data.name;
                            option.textContent = data.name || "(no name)";
                            select.appendChild(option);
                        });
                        document.getElementById('locationReport-sec').classList.remove('hidden');
                        document.getElementById('searchReport-sec').classList.remove('md:grid-cols-3');
                        document.getElementById('searchReport-sec').classList.add('md:grid-cols-4');
                    } else {
                        document.getElementById('locationReport-sec').classList.add('hidden');
                        document.getElementById('searchReport-sec').classList.remove('md:grid-cols-4');
                        document.getElementById('searchReport-sec').classList.add('md:grid-cols-3');
                    }
                    showNotification('success', 'เข้าสู่ระบบสำเร็จ', 'ยินดีต้อนรับ คุณ ' + name);
                } else {
                    showNotification('error', 'Warning', 'Not permission.');
                    auth.signOut();
                }

                await getDiagnosis()
                await getMedicineUnit()
                //loadMessages();
            } else {
                //status.textContent = "Not logged in";
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
            }
            hideLoading();
        });
        // DOM Elements
        var isAdmin = false;
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const medicalRecordForm = document.getElementById('medicalRecordForm');
        const searchEmployeeBtn = document.getElementById('searchEmployeeBtn');
        const newCustomerBtn = document.getElementById('newCustomerBtn');
        const searchBtn = document.getElementById('searchBtn');
        const saveCustomerBtn = document.getElementById('saveCustomerBtn');
        const saveOpdCardBtn = document.getElementById('saveOpdCardBtn');
        const clearOpdCardBtn = document.getElementById('clearOpdCardBtn');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const recordDetail = document.getElementById('recordDetail');
        const recordDetailContent = document.getElementById('recordDetailContent');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const reportResults = document.getElementById('reportResults');
        const reportChart = document.getElementById('reportChart');
        const notification = document.getElementById('notification');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        const notificationIcon = document.getElementById('notificationIcon');
        const closeNotification = document.getElementById('closeNotification');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');
        //document.getElementById("location").innerText = "This is the new paragraph text.";
        // Chart instance
        let myChart = null;
        // Set today's date as default for visit date
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('visitDate2').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        // Set default dates for reports
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const firstDayFormatted = `${firstDayOfMonth.getFullYear()}-${String(firstDayOfMonth.getMonth() + 1).padStart(2, '0')}-${String(firstDayOfMonth.getDate()).padStart(2, '0')}`;
        const todayFormatted = `${year}-${month}-${day}`;
        document.getElementById('reportEndDate').value = todayFormatted;
        document.getElementById('reportStartDate').value = firstDayFormatted;
        // Tab Switching
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                // Show selected tab content
                tabContents.forEach(content => {
                    if (content.id === tabId) {
                        content.classList.remove('hidden');
                        content.classList.add('fade-in');
                    } else {
                        content.classList.add('hidden');
                        content.classList.remove('fade-in');
                    }
                });
            });
        });
        newCustomerBtn.addEventListener('click', () => {

            document.getElementById('customer-result').classList.add('hidden');
            document.getElementById('customer-insert').classList.remove('hidden');
        });
		
        const encryptText = functions.httpsCallable("encryptText");
        const cache = new Map();

        async function encryptTextFnCached(text) {
            if (cache.has(text)) {
                // ถ้ามี cache อยู่แล้ว ให้คืนค่าจาก cache เลย
                console.log("From cache:", text);
                return cache.get(text);
            }

            // ถ้าไม่มี cache เรียกฟังก์ชันและเก็บผลลัพธ์
            try {
                const result = await encryptText({ text });
                const encrypted = result.data.encrypted;
                cache.set(text, encrypted);
                return encrypted;
            } catch (error) {
                console.error("Error:", error);
                throw error;
            }
        }

	    async function encryptTextFn(text){
			
		  try {
			const result = await encryptText({ text }); 
			console.log("Encrypted:", result.data.encrypted);
			return result.data.encrypted; // ต้อง return ค่านี้ออกไป
		  } catch (error) {
			console.error("Error:", error);
			throw error; // โยน error ต่อให้คนเรียกจัดการ
		  }
        }

        const decryptText = functions.httpsCallable('decryptText');
        const decryptCache = new Map();

        async function decryptTextFnCached(encrypted) {
            if (decryptCache.has(encrypted)) {
                console.log("Decrypt from cache:", encrypted);
                return decryptCache.get(encrypted);
            }

            try {
                const result = await decryptText({ encrypted });
                const decrypted = result.data.decrypted;
                decryptCache.set(encrypted, decrypted);
                return decrypted;
            } catch (error) {
                console.error("Error:", error);
                throw error;
            }
        }

		async function decryptTextFn(encrypted){
		
			try {
				const result = await decryptText({ encrypted }); 
				console.log("Decrypted:", result.data.decrypted);
				return result.data.decrypted; // ต้อง return ค่านี้ออกไป
			  } catch (error) {
				console.error("Error:", error);
				throw error; // โยน error ต่อให้คนเรียกจัดการ
			  }
		
        }
			
	
        function back2SearchBtn3() {
            //document.getElementById('searchResults').classList.add('hidden');
            displayEmployeeSearchResults(matchedEmployees);
        }
         function saveCustomerBtn3() {
            if (confirm('คุณต้องการบันทึกใช่หรือไม่?')) {


                const employeeId = document.getElementById('employeeId3').value;
                //const firstName = document.getElementById('firstName3').value;
                //const lastName = document.getElementById('lastName3').value;
                const department = document.getElementById('department3').value;
                const birthdate = document.getElementById('birthdate3').value;
                const phone = document.getElementById('phone3').value;
                const congenitalDisease = document.getElementById('congenitalDisease3').value;
                const allergies = document.getElementById('allergies3').value;
                if (!employeeId /*|| !firstName || !lastName || !department*/) {
                    showNotification('error', 'ข้อผิดพลาด', 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน');
                    return;
                }
                showLoading('กำลังบันทึกข้อมูล...');
                // Simulate API call with timeout
                setTimeout(async () => {


                    const encryptedValue = await encryptTextFnCached(employeeId);
                    db.collection("employees").doc(customerDb.id).update({
                        employeeId: encryptedValue,
                        /*firstName: firstName,
                        lastName: lastName,*/
                        department: department,
                        birthdate: birthdate,
                        phone: phone,
                        congenitalDisease: congenitalDisease,
                        allergies: allergies,
                        updateDate: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: userDb.data().name
                    })
                        .then((docRef) => {
                            //docRef.id
                            db.collection("employees").doc(customerDb.id).get()
                                .then((doc) => {
                                    if (doc.exists) {
                                        customerDb = doc;
                                    }
                                });


                            showNotification('success', 'สำเร็จ', 'บันทึกข้อมูลสำเร็จ');

                            document.getElementById('employeeId2').value = employeeId;
                            //document.getElementById('firstName2').value = firstName;
                            //document.getElementById('lastName2').value = lastName;
                            document.getElementById('congenitalDisease2').value = congenitalDisease;
                            document.getElementById('allergies2').value = allergies;

                        })
                        .catch((error) => {
                            showNotification('error', 'เกิดข้อผิดพลาด', 'เกิดข้อผิดพลาด');
                        });
                    hideLoading();

                }, 1200);
            }
        }

       saveCustomerBtn.addEventListener('click', () => {

            const employeeId = document.getElementById('employeeId1').value;
            //const firstName = document.getElementById('firstName1').value;
            //const lastName = document.getElementById('lastName1').value;
            const department = document.getElementById('department1').value;
            const birthdate = document.getElementById('birthdate1').value;
            const phone = document.getElementById('phone1').value;
            const congenitalDisease = document.getElementById('congenitalDisease1').value;
            const allergies = document.getElementById('allergies1').value;
            if (!employeeId /*|| !firstName || !lastName || !department*/) {
                showNotification('error', 'ข้อผิดพลาด', 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน');
                return;
            }
            if (confirm('คุณต้องการบันทึกใช่หรือไม่?')) {
                showLoading('กำลังบันทึกข้อมูล...');
                // Simulate API call with timeout
                setTimeout(async () => {
                    const encryptedValue = await encryptTextFnCached(employeeId);
                    db.collection("employees").add({
                        employeeId: encryptedValue,
                        //firstName: firstName,
                        //lastName: lastName,
                        department: department,
                        birthdate: birthdate,
                        phone: phone,
                        congenitalDisease: congenitalDisease,
                        allergies: allergies,
                        createdDate: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: userDb.data().name
                    })
                        .then((docRef) => {
                            //docRef.id
                            customerDb = docRef;
                            showNotification('success', 'สำเร็จ', 'บันทึกข้อมูลสำเร็จ');

                            document.getElementById('employeeId2').value = employeeId;
                            //document.getElementById('firstName2').value = firstName;
                            //document.getElementById('lastName2').value = lastName;
                            document.getElementById('congenitalDisease2').value = congenitalDisease;
                            document.getElementById('allergies2').value = allergies;

                            document.getElementById('employeeId1').value = '';
                            //document.getElementById('firstName1').value = '';
                            //document.getElementById('lastName1').value = '';
                            document.getElementById('department1').value = '';
                            document.getElementById('birthdate1').value = '';
                            document.getElementById('phone1').value = '';
                            document.getElementById('congenitalDisease1').value = '';
                            document.getElementById('allergies1').value = '';
                        })
                        .catch((error) => {
                            showNotification('error', 'เกิดข้อผิดพลาด', 'เกิดข้อผิดพลาด');
                        });
                    hideLoading();

                }, 1200);
            }
            /*const visitDate = document.getElementById('visitDate').value;
            const esiTriage = document.getElementById('esiTriage').value;
            const temperature = document.getElementById('temperature').value;
            const pulse = document.getElementById('pulse').value;
            const respiration = document.getElementById('respiration').value;
            const bloodPressure = document.getElementById('bloodPressure').value;
            const oxygenSaturation = document.getElementById('oxygenSaturation').value;
            const chiefComplaint = document.getElementById('chiefComplaint').value;
            const physicalExamination = document.getElementById('physicalExamination').value;
            const diagnosis = document.getElementById('diagnosis').value;
            const treatment = document.getElementById('treatment').value;
            const advice = document.getElementById('advice').value;
            const followUp = document.querySelector('input[name="followUp"]:checked').value;
            const serviceType = document.getElementById('serviceType').value;
            // Validate required fields
            if (!employeeId || !firstName || !lastName || !department || !visitDate || !esiTriage || !chiefComplaint || !serviceType) {
                showNotification('error', 'ข้อผิดพลาด', 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน');
                return;
            }
            showLoading('กำลังบันทึกข้อมูล...');
            // Simulate API call with timeout
            setTimeout(() => {
                // Generate new record ID
                const recordId = 'R' + String(Object.keys(sampleData.medicalRecords).length + 1).padStart(3, '0');
                // Save employee data
                sampleData.employees[employeeId] = {
                    firstName,
                    lastName,
                    department,
                    birthdate,
                    phone,
                    congenitalDisease,
                    allergies,
                    updatedAt: new Date().toISOString()
                };
                // Save medical record
                sampleData.medicalRecords[recordId] = {
                    id: recordId,
                    employeeId,
                    visitDate: new Date(visitDate).toISOString(),
                    esiTriage,
                    vitalSigns: {
                        temperature,
                        pulse,
                        respiration,
                        bloodPressure,
                        oxygenSaturation
                    },
                    chiefComplaint,
                    physicalExamination,
                    diagnosis,
                    treatment,
                    advice,
                    followUp,
                    serviceType,
                    createdAt: new Date().toISOString(),
                    createdBy: "เจ้าหน้าที่พยาบาล"
                };
                // Update employee medical records
                if (!sampleData.employeeMedicalRecords[employeeId]) {
                    sampleData.employeeMedicalRecords[employeeId] = {};
                }
                sampleData.employeeMedicalRecords[employeeId][recordId] = true;
                hideLoading();
                showNotification('success', 'สำเร็จ', 'บันทึกข้อมูลสำเร็จ');
                medicalRecordForm.reset();
                document.getElementById('visitDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }, 1200);
            */
            //showNotification('success', 'สำเร็จ', 'บันทึกข้อมูลสำเร็จ');
        });
        // Search Employee
        searchEmployeeBtn.addEventListener('click', () => {
            const employeeId = document.getElementById('employeeId').value;
            if (!employeeId) {
                showNotification('error', 'ข้อผิดพลาด', 'กรุณากรอกรหัสพนักงาน');
                return;
            }
            showLoading('กำลังค้นหาข้อมูลพนักงาน...');
            // Simulate API call with timeout
            setTimeout(() => {
                const employeeData = sampleData.employees[employeeId];
                if (employeeData) {
                    // Fill form with employee data
                    //document.getElementById('firstName').value = employeeData.firstName || '';
                    //document.getElementById('lastName').value = employeeData.lastName || '';
                    document.getElementById('department').value = employeeData.department || '';
                    document.getElementById('birthdate').value = employeeData.birthdate || '';
                    document.getElementById('phone').value = employeeData.phone || '';
                    document.getElementById('congenitalDisease').value = employeeData.congenitalDisease || '';
                    document.getElementById('allergies').value = employeeData.allergies || '';
                    showNotification('success', 'สำเร็จ', 'พบข้อมูลพนักงาน');
                } else {
                    showNotification('warning', 'ไม่พบข้อมูล', 'ไม่พบข้อมูลพนักงาน กรุณากรอกข้อมูลใหม่');
                }
                hideLoading();
            }, 800);
        });

        saveOpdCardBtn.addEventListener('click', () => {
            const employeeId = document.getElementById('employeeId2').value;
            //const firstName = document.getElementById('firstName2').value;
            //const lastName = document.getElementById('lastName2').value;

            const visitDate = document.getElementById('visitDate2').value;
            const esiTriage = document.getElementById('esiTriage2').value;
            const temperature = document.getElementById('temperature2').value;
            const pulse = document.getElementById('pulse2').value;
            const respiration = document.getElementById('respiration2').value;
            const bloodPressure = document.getElementById('bloodPressure2').value;
            const oxygenSaturation = document.getElementById('oxygenSaturation2').value;
            const chiefComplaint = document.getElementById('chiefComplaint2').value;
            const physicalExamination = document.getElementById('physicalExamination2').value;
            const diagnosis = document.getElementById('diagnosis2').value;
            const advice = document.getElementById('advice2').value;
            const serviceType = document.getElementById('serviceType2').value;
            const followUp = document.querySelector('input[name="followUp2"]:checked').value;
            //console.log(followUpValue); // ได้ "Y" หรือ "N"
         
            if (!employeeId /*|| !firstName || !lastName*/ || !visitDate || !esiTriage || !serviceType2) {
                showNotification('error', 'ข้อผิดพลาด', 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน');
                return;
            }
            if (confirm('คุณต้องการบันทึกใช่หรือไม่?')) {
                showLoading('กำลังค้นหาข้อมูล...');
                setTimeout(() => {

                    db.collection("employees").doc(customerDb.id).collection("opdCard").add({
                        visitDate: visitDate,
                        esiTriage: esiTriage,
                        temperature: temperature,
                        respiration: respiration,
                        bloodPressure: bloodPressure,
                        oxygenSaturation: oxygenSaturation,
                        chiefComplaint: chiefComplaint,
                        physicalExamination: physicalExamination,
                        diagnosis: diagnosis,
                        pulse: pulse,
                        advice: advice,
                        serviceType: serviceType,
                        followUp: followUp,
                        medicines: medicines,
                        location: userDb.data().location,
                        createdDate: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: userDb.data().name,

                    })
                        .then((docRef) => {
                            //docRef.id
                            showNotification('success', 'สำเร็จ', 'บันทึกข้อมูลสำเร็จ');

                            document.getElementById("medicalRecordForm").reset();
                            const now = new Date();
                            const year = now.getFullYear();
                            const month = String(now.getMonth() + 1).padStart(2, '0');
                            const day = String(now.getDate()).padStart(2, '0');
                            const hours = String(now.getHours()).padStart(2, '0');
                            const minutes = String(now.getMinutes()).padStart(2, '0');
                            document.getElementById("visitDate2").value = `${year}-${month}-${day}T${hours}:${minutes}`;

                            editingIndex = -1;
                            medicines = [];
                            renderTable();

                        })
                        .catch((error) => {
                            showNotification('error', 'เกิดข้อผิดพลาด', 'เกิดข้อผิดพลาด');
                        });
                    hideLoading();

                }, 1200);
            }
        });
        clearOpdCardBtn.addEventListener('click', () => {
            document.getElementById("medicalRecordForm").reset();
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById("visitDate2").value = `${year}-${month}-${day}T${hours}:${minutes}`;

            editingIndex = -1;
            medicines = [];
            renderTable();
        });
        async function getDiagnosis() {
            let snapshot = await db.collection("ICD10").orderBy("short_description").get();

            const select = document.getElementById("diagnosis2");

            // ลบ option เดิมทั้งหมดก่อน (optional)
            select.innerHTML = "";

            // สร้าง option แรกที่เป็น "-- เลือก --"
            const defaultOption = document.createElement("option");
            defaultOption.textContent = "-- เลือก --";
            defaultOption.value = '';        // หรือ "none"
            //defaultOption.disabled = true;
            defaultOption.selected = true;

            select.appendChild(defaultOption);

            snapshot.forEach((doc) => {
                const data = doc.data();
                const option = document.createElement("option");
                //option.value = doc.id;
                option.value = data.short_description;
                option.textContent = data.short_description || "(no name)";
                select.appendChild(option);
            });

            const choices = new Choices(select, {
                searchEnabled: true,
                itemSelectText: '',
                shouldSort: false
            });
        }
        const typeSelect = document.getElementById("editMedicineType");
        const nameSelect = document.getElementById("editMedicineName");
        const unitSelect = document.getElementById("editMedicineUnit");
        const allData = []; // เก็บข้อมูลทั้งหมด
        var uniqueTypes = [];
        var uniqueNames = [];
        var uniqueUnit = [];

        var nameChoices;
        async function getMedicineUnit() {

            typeSelect.innerHTML = "";
            nameSelect.innerHTML = "";
            const defaultOption = document.createElement("option");
            defaultOption.textContent = "-- เลือก --";
            defaultOption.value = '';        // หรือ "none"
            //defaultOption.disabled = true;
            defaultOption.selected = true;

            const defaultOption2 = document.createElement("option");
            defaultOption2.textContent = "-- เลือก --";
            defaultOption2.value = '';        // หรือ "none"
            //defaultOption.disabled = true;
            defaultOption2.selected = true;

            typeSelect.appendChild(defaultOption);
            nameSelect.appendChild(defaultOption2);

            nameChoices = new Choices(nameSelect, {
                searchEnabled: true,
                itemSelectText: '',
                shouldSort: false
            });

            db.collection("medicine").get().then(snapshot => {
                snapshot.forEach(doc => allData.push(doc.data()));

                uniqueTypes = [...new Set(allData.map(i => i.type))];
                uniqueTypes.sort((a, b) => a.localeCompare(b));
                uniqueTypes.forEach(type => {
                    const opt = document.createElement("option");
                    opt.value = opt.textContent = type;
                    typeSelect.appendChild(opt);
                });

                uniqueNames = [...new Set(allData.map(i => i.name))];
                uniqueNames.sort((a, b) => a.localeCompare(b));
                /*uniqueNames.forEach(name => {
                    const opt = document.createElement("option");
                    opt.value = opt.textContent = name;
                    nameSelect.appendChild(opt);
                });*/

                //nameChoices.clearChoices();
                const defaultChoice = { value: '', label: '-- เลือก --', disabled: true, selected: true };
                nameChoices.setChoices(
                    [defaultChoice,
                        ...uniqueNames.map(n => ({ value: n, label: n }))],
                    'value', 'label', false
                );

                uniqueUnit = [...new Set(allData.map(i => i.unit))];
                uniqueUnit.sort((a, b) => a.localeCompare(b));

               
            });

            /*let snapshot = await db.collection("medicine").orderBy("name").get();

            const select = document.getElementById("editMedicineName");

            // ลบ option เดิมทั้งหมดก่อน (optional)
            select.innerHTML = "";

            // สร้าง option แรกที่เป็น "-- เลือก --"
            const defaultOption = document.createElement("option");
            defaultOption.textContent = "-- เลือก --";
            defaultOption.value = '';        // หรือ "none"
            //defaultOption.disabled = true;
            defaultOption.selected = true;

            select.appendChild(defaultOption);

            snapshot.forEach((doc) => {
                const data = doc.data();
                const option = document.createElement("option");
                //option.value = doc.id;
                option.value = data.name;
                option.textContent = data.name || "(no name)";
                select.appendChild(option);
            });*/

        }
        // ✅ 3. เมื่อเลือก type → กรอง name
        typeSelect.addEventListener("change", () => {
            //nameSelect.innerHTML = '<option>-- เลือก --</option>';
            unitSelect.innerHTML = '<option>-- เลือก --</option>';
            //unitSelect.disabled = true;

            const selectedType = typeSelect.value;
            const filteredNames = allData.filter(i => i.type === selectedType);
            const uniqueNames2 = [...new Set(filteredNames.map(i => i.name))];

            nameChoices.removeActiveItems();
            nameChoices.clearChoices();
            const defaultChoice = { value: '', label: '-- เลือก --', disabled: true, selected: true };
            if (uniqueNames2.length == 0) {
                uniqueNames.sort((a, b) => a.localeCompare(b));
                /*uniqueNames.forEach(name => {
                    const opt = document.createElement("option");
                    opt.value = opt.textContent = name;
                    nameSelect.appendChild(opt);
                });*/
                    
                nameChoices.setChoices(
                    [defaultChoice,
                        ...uniqueNames.map(n => ({ value: n, label: n }))],
                    'value', 'label', true
                );
            } else {
                uniqueNames2.sort((a, b) => a.localeCompare(b));
                /*uniqueNames2.forEach(name => {
                    const opt = document.createElement("option");
                    opt.value = opt.textContent = name;
                    nameSelect.appendChild(opt);
                });*/
                nameChoices.setChoices(
                    [defaultChoice,
                        ...uniqueNames2.map(n => ({ value: n, label: n }))],
                    'value', 'label', true
                );
            }

        });

        // ✅ 4. เมื่อเลือก name → แสดง unit
        nameSelect.addEventListener("change", () => {
            unitSelect.innerHTML = '<option>-- เลือก Unit --</option>';
            //unitSelect.disabled = false;

            //const selectedType = typeSelect.value;
            const selectedName = nameSelect.value;

            const match = allData.find(i => /*i.type === selectedType &&*/ i.name === selectedName);
            if (match) {
                const opt = document.createElement("option");
                opt.value = opt.textContent = match.unit;
                unitSelect.appendChild(opt);
                unitSelect.value = opt.value;

                typeSelect.value = match.type;

            }

    
        });
		function googleLogin() {
		  var provider = new firebase.auth.GoogleAuthProvider();
		//firebase.auth().signInWithRedirect(provider);
			
			firebase.auth().signInWithPopup(provider)
			  .then(function(result) {
				var user = result.user;
				console.log("Sign-in success", user);
				//alert("ยินดีต้อนรับ " + user.displayName);
			  })
			  .catch(function(error) {
				console.error(error);
			  });
		}
        function login() {
            //document.getElementById('auth-section').classList.remove('hidden');
            //document.getElementById('editModal').classList.add('flex');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password).catch(err => {
                alert(err.message);
                hideLoading();
            });
            showLoading();
            //document.getElementById('auth-section').classList.add('hidden');
            //document.getElementById('dashboard').classList.remove('hidden');
        }
        async function saveLocation() {
            let location = document.getElementById("locationSel").value;
            if (location != '') {
                document.getElementById("location").innerText = location;
                //console.log(userDb.id)
                const docRef = db.collection("staff").doc(userDb.id); // เปลี่ยน doc1 เป็น id จริง

                docRef.update({
                    location: location
                })
                    .then(() => {
                        //showNotification('success', 'เข้าสู่ระบบสำเร็จ', 'ยินดีต้อนรับ คุณ ' + name);
                        //alert("อัปเดตเรียบร้อย!");
                        document.getElementById('location-section').classList.add('hidden');
                    })
                    .catch((error) => {
                        //console.error("เกิดข้อผิดพลาด:", error);
                        showNotification('error', 'ข้อผิดพลาด', 'ข้อผิดพลาด');
                    });
            }

        }
        async function changeLocation() {
            if (isAdmin) {
                let snapshot = await db.collection("location").get();

                const select = document.getElementById("locationSel");

                // ลบ option เดิมทั้งหมดก่อน (optional)
                select.innerHTML = "";

                // สร้าง option แรกที่เป็น "-- เลือก --"
                const defaultOption = document.createElement("option");
                defaultOption.textContent = "-- เลือก --";
                defaultOption.value = '';        // หรือ "none"
                defaultOption.disabled = true;
                defaultOption.selected = true;

                select.appendChild(defaultOption);

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const option = document.createElement("option");
                    //option.value = doc.id;
                    option.value = data.name;
                    option.textContent = data.name || "(no name)";
                    select.appendChild(option);
                });

                document.getElementById('location-section').classList.remove('hidden');
            }

        }

        function logout() {
            //document.getElementById('auth-section').classList.remove('hidden');
            //document.getElementById('editModal').classList.add('flex');
            //document.getElementById('auth-section').classList.remove('hidden');
            //document.getElementById('dashboard').classList.add('hidden');
            auth.signOut();
        }

		let timeoutId;

		// ฟังก์ชันที่ต้องการเรียกเมื่อไม่มี activity เกิน 2 ชั่วโมง
		function onInactivity() {
		  console.log("ไม่มี activity เกิน 2 ชั่วโมง! เรียกฟังก์ชันที่นี่ได้เลย");
		  // ตัวอย่าง: เรียก firebase function หรือทำอย่างอื่น
		  logout();
		}

		// รีเซ็ต timer ทุกครั้งที่มี activity
		function resetTimer() {
		  clearTimeout(timeoutId);
		  // ตั้ง timeout ใหม่ 2 ชั่วโมง = 2 * 60 * 60 * 1000 ms = 7,200,000 ms
		  timeoutId = setTimeout(onInactivity, 1 * 60 * 60 * 1000);
		}

		// ฟัง event ที่แสดง activity ผู้ใช้
		window.addEventListener('mousemove', resetTimer);
		window.addEventListener('keydown', resetTimer);
		window.addEventListener('scroll', resetTimer);
		window.addEventListener('touchstart', resetTimer);

		// เริ่มนับตั้งแต่โหลดเพจ
		resetTimer();

        //
        // Submit Medical Record Form
        medicalRecordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // Get form data
            const employeeId = document.getElementById('employeeId').value;
            //const firstName = document.getElementById('firstName').value;
            //const lastName = document.getElementById('lastName').value;
            const department = document.getElementById('department').value;
            const birthdate = document.getElementById('birthdate').value;
            const phone = document.getElementById('phone').value;
            const congenitalDisease = document.getElementById('congenitalDisease').value;
            const allergies = document.getElementById('allergies').value;
            const visitDate = document.getElementById('visitDate').value;
            const esiTriage = document.getElementById('esiTriage').value;
            const temperature = document.getElementById('temperature').value;
            const pulse = document.getElementById('pulse').value;
            const respiration = document.getElementById('respiration').value;
            const bloodPressure = document.getElementById('bloodPressure').value;
            const oxygenSaturation = document.getElementById('oxygenSaturation').value;
            const chiefComplaint = document.getElementById('chiefComplaint').value;
            const physicalExamination = document.getElementById('physicalExamination').value;
            const diagnosis = document.getElementById('diagnosis').value;
            const treatment = document.getElementById('treatment').value;
            const advice = document.getElementById('advice').value;
            const followUp = document.querySelector('input[name="followUp"]:checked').value;
            const serviceType = document.getElementById('serviceType').value;
            // Validate required fields
            if (!employeeId || /*!firstName || !lastName || !department ||*/ !visitDate || !esiTriage || !chiefComplaint || !serviceType) {
                showNotification('error', 'ข้อผิดพลาด', 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน');
                return;
            }
            showLoading('กำลังบันทึกข้อมูล...');
            // Simulate API call with timeout
            setTimeout(() => {
                // Generate new record ID
                const recordId = 'R' + String(Object.keys(sampleData.medicalRecords).length + 1).padStart(3, '0');
                // Save employee data
                sampleData.employees[employeeId] = {
                    //firstName,
                    //lastName,
                    department,
                    birthdate,
                    phone,
                    congenitalDisease,
                    allergies,
                    updatedAt: new Date().toISOString()
                };
                // Save medical record
                sampleData.medicalRecords[recordId] = {
                    id: recordId,
                    employeeId,
                    visitDate: new Date(visitDate).toISOString(),
                    esiTriage,
                    vitalSigns: {
                        temperature,
                        pulse,
                        respiration,
                        bloodPressure,
                        oxygenSaturation
                    },
                    chiefComplaint,
                    physicalExamination,
                    diagnosis,
                    treatment,
                    advice,
                    followUp,
                    serviceType,
                    createdAt: new Date().toISOString(),
                    createdBy: "เจ้าหน้าที่พยาบาล"
                };
                // Update employee medical records
                if (!sampleData.employeeMedicalRecords[employeeId]) {
                    sampleData.employeeMedicalRecords[employeeId] = {};
                }
                sampleData.employeeMedicalRecords[employeeId][recordId] = true;
                hideLoading();
                showNotification('success', 'สำเร็จ', 'บันทึกข้อมูลสำเร็จ');
                medicalRecordForm.reset();
                document.getElementById('visitDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }, 1200);
        });
        // Search Records
        searchBtn.addEventListener('click', () => {
            /*const searchValue = searchInput.value.trim();
            if (!searchValue) {
                showNotification('error', 'ข้อผิดพลาด', 'กรุณากรอกข้อมูลที่ต้องการค้นหา');
                return;
            }*/
            document.getElementById('customer-result').classList.remove('hidden');
            document.getElementById('customer-insert').classList.add('hidden');
            const searchValue = searchInput.value.trim();

            showLoading('กำลังค้นหาข้อมูล...');
            // Simulate API call with timeout
            setTimeout(async () => {
                // First try to search by employee ID

                await searchRecordsByName(searchValue);
                /*if (sampleData.employees[searchValue]) {
                    // Found by employee ID
                    const employeeData = sampleData.employees[searchValue];
                    searchRecordsByEmployeeId(searchValue, employeeData);
                } else {
                    // Try to search by name
                    searchRecordsByName(searchValue);
                }*/
                hideLoading();
            }, 800);
        });
        // Search Records by Employee ID
        function searchRecordsByEmployeeId(employeeId, employeeData) {
            const employeeMedicalRecords = sampleData.employeeMedicalRecords[employeeId];
            if (employeeMedicalRecords) {
                const recordIds = Object.keys(employeeMedicalRecords);
                const records = recordIds.map(id => sampleData.medicalRecords[id]);
                // Sort records by visit date (newest first)
                records.sort((a, b) => new Date(b.visitDate) - new Date(a.visitDate));
                displayMedicalRecords(records, employeeData);
            } else {
                searchResults.innerHTML = `

                                                                                                                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                                                                                                            <div class="flex">
                                                                                                                                <div class="flex-shrink-0">
                                                                                                                                    <svg class="h-5 w-5 text-yellow-400"
                                                                                                                                        xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                                                                                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                                                                                                    </svg>
                                                                                                                                </div>
                                                                                                                                <div class="ml-3">
                                                                                                                                    <p class="text-sm text-yellow-700">
                              พบข้อมูลพนักงาน ${employeeData.employeeId}  แต่ไม่พบประวัติการรักษา
                            </p>
                                                                                                                                </div>
                                                                                                                            </div>
                                                                                                                        </div>
                    `;
                recordDetail.classList.add('hidden');
            }
        }
        var matchedEmployees = [];
        // Search Records by Name
        async function searchRecordsByName(name) {
            matchedEmployees = [];
            // Search by first name
            /*Object.keys(sampleData.employees).forEach(employeeId => {
                const employee = sampleData.employees[employeeId];
                if (employee.firstName.includes(name) || employee.lastName.includes(name)) {
                    matchedEmployees.push({
                        id: employeeId,
                        ...employee
                    });
                }
            });*/

            const searchText = name;
            const keywords = searchText.trim().toLowerCase().split(/\s+/); // ['aa', 'bb', 'cc']

            const snapshot = await db.collection("employees").get();
            //db.collection("employees").get().then(snapshot => {
            //const matchedEmployees = [];
            
            const employees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const decryptedList = await Promise.all(
                employees.map(emp => decryptTextFnCached(emp.employeeId))
            );
   
            matchedEmployees = employees
                .map((emp, i) => ({
                    ...emp,
                    decryptedEmployeeId: decryptedList[i],
                }))
                .filter(emp =>
                    keywords.every(keyword => emp.decryptedEmployeeId.toLowerCase().includes(keyword))
                )
                .map(emp => ({
                    id: emp.id,
                    employeeId: emp.decryptedEmployeeId,
                    department: emp.department,
                    // เพิ่มฟิลด์อื่น ๆ ตามต้องการ เช่น firstName, lastName ...
                }));
            /*for (const data of matchedEmployees2) {
                const text = data.employeeId;
                // ต้อง match ทุกคำ (AND)
              
                const isMatch = keywords.every(keyword =>
                    text.includes(keyword)
                );
                const isMatch = text.indexOf(searchText) > 0;
                if (isMatch) {
                    //  results.push({ id: doc.id, ...data });
                    matchedEmployees.push({
                        id: data.id,
                        employeeId: data.employeeId,
                        //employeeId: data.employeeId,
                        //firstName: data.firstName,
                        //lastName: data.lastName,
                        //department: data.department
                    });
                }
            }*/

                /*for (const doc of snapshot.docs) {
                //snapshot.forEach(doc =>  {
                    const data = doc.data();
                    //const text = `${data.employeeId} ${data.firstName} ${data.lastName}`.toLowerCase();
                    //const text = `${data.employeeId}`.toLowerCase();
                    try {
                        //console.log(doc.id)
                        if (data.employeeId.length > 10) {
                            const text = await decryptTextFnCached(data.employeeId);
                            // ต้อง match ทุกคำ (AND)
                            const isMatch = keywords.every(keyword =>
                                text.includes(keyword)
                            );

                            if (isMatch) {
                                //  results.push({ id: doc.id, ...data });
                                matchedEmployees.push({
                                    id: doc.id,
                                    employeeId: text,
                                    //employeeId: data.employeeId,
                                    //firstName: data.firstName,
                                    //lastName: data.lastName,
                                    //department: data.department
                                });
                            }
                        } else {
                            const encryptedValue = await encryptTextFnCached(data.employeeId);
                            db.collection("employees").doc(doc.id).update({
                                employeeId: encryptedValue
                            });
                        }
                    } catch {}
                };*/

                //console.log("ผลลัพธ์ที่พบ:", matchedEmployees);

                if (matchedEmployees.length > 0) {
                    matchedEmployees.sort((a, b) => {
                        //return (a.firstName + ' ' + a.lastName).localeCompare(b.firstName + ' ' + b.lastName);
                        return (a.employeeId).localeCompare(b.employeeId);
                    });
                    displayEmployeeSearchResults(matchedEmployees);
                } else {
                    searchResults.innerHTML = `

                                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <svg class="h-5 w-5 text-yellow-400"
                                                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-yellow-700">
                                          ไม่พบข้อมูลที่ตรงกับคำค้นหา "${name}"
                                        </p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                    recordDetail.classList.add('hidden');
                }
            //});
        }
        // Display Employee Search Results
        async function displayEmployeeSearchResults(employees) {
            let html = `

                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รหัสพนักงาน</th>
                                <!--<th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อ-นามสกุล</th>-->
                                <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">แผนก</th>
                                <th class="py-2 px-4 border-b text-center text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody>
                  `;

			/*const encryptedList = await Promise.all(
			  employees.map(emp => encryptTextFn(emp.employeeId))
			);
			employees.forEach((emp, index) => {
			  emp.employeeIdEnc = encryptedList[index];
			});*/
					
            employees.forEach(employee => {	
                html += `
                    <tr>
                        <td class="py-2 px-4 border-b">${employee.employeeId}</td>
                        <!--<td class="py-2 px-4 border-b">${employee.firstName} ${employee.lastName}</td>-->
                        <td class="py-2 px-4 border-b">${employee.department || '-'}</td>
                        <td class="py-2 px-4 text-center border-b">
                            <button class="view-records-btn text-white bg-turquoise hover:bg-turquoise-light px-3 py-1 rounded-md text-sm" data-id="${employee.id}" data-employee-id="${employee.employeeId}" >
                            <!--<button class="view-records-btn text-white bg-turquoise hover:bg-turquoise-light px-3 py-1 rounded-md text-sm" data-id="${employee.id}" data-employee-id="${employee.employeeId}" data-employee-name="${employee.firstName} ${employee.lastName}">-->
                            ดูประวัติ
                          </button>
                        </td>
                    </tr>
                    `;
            });
            html += `

                                </tbody>
                            </table>
                        </div>
                  `;
            searchResults.innerHTML = html;
            recordDetail.classList.add('hidden');
            // Add event listeners to view records buttons
            document.querySelectorAll('.view-records-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.getAttribute('data-id');
                    const employeeId = e.target.getAttribute('data-employee-id');
                    //const employeeName = e.target.getAttribute('data-employee-name');
                    showLoading('กำลังดึงข้อมูลประวัติการรักษา...');
                    // Simulate API call with timeout

                    //customerDb
                    db.collection("employees").doc(id).get()
                        .then((doc) => {
                            if (doc.exists) {
                                customerDb = doc;

                                document.getElementById('employeeId2').value = employeeId;
                                //document.getElementById('firstName2').value = employeeName.split(' ')[0];
                                //document.getElementById('lastName2').value = employeeName.split(' ')[1];
                                document.getElementById('allergies2').value = customerDb.data().allergies;
                                document.getElementById('congenitalDisease2').value = customerDb.data().congenitalDisease;
                                //document.getElementById("resultBox").textContent =
                                //    JSON.stringify(doc.data(), null, 2);
                            } else {
                                //document.getElementById("resultBox").textContent =
                                //    "ไม่พบเอกสารนี้ใน Firestore";
                            }
                        })
                        .catch((error) => {
                            console.error("เกิดข้อผิดพลาด:", error);
                            alert("เกิดข้อผิดพลาดในการดึงข้อมูล");
                        });


                    //document.getElementById('congenitalDisease2').value = congenitalDisease;
                    //document.getElementById('allergies2').value = allergies;

                    setTimeout(() => {
                        /*const employeeMedicalRecords = sampleData.employeeMedicalRecords[employeeId];
                        if (employeeMedicalRecords) {
                            const recordIds = Object.keys(employeeMedicalRecords);
                            const records = recordIds.map(id => sampleData.medicalRecords[id]);
                            // Sort records by visit date (newest first)
                            records.sort((a, b) => new Date(b.visitDate) - new Date(a.visitDate));
                            displayMedicalRecords(records, {
                                firstName: employeeName.split(' ')[0],
                                lastName: employeeName.split(' ')[1]
                            });
                        } else {
                            showNotification('warning', 'ไม่พบข้อมูล', `ไม่พบประวัติการรักษาของ ${employeeName}`);
                            recordDetail.classList.add('hidden');
                        }*/

                        /*db.collection("employees").doc(id).where("email", "==", user.email).get();
                        if (snapshot.docs.length > 0) {

                        }*/
                        /*snapshot.forEach((doc) => {
                              // doc.data() is never undefined for query doc snapshots
                              console.log(doc.id, " => ", doc.data());
                        });*/
                        /*if (snapshot.docs.length > 0) {
                            userDb = snapshot.docs[0];
                            let firstDoc = snapshot.docs[0];
                            let name = firstDoc.data().name;*/
                        let location = userDb.data().location;

                        let opdQuery = db.collection("employees")
                            .doc(id)
                            .collection("opdCard");

                        // 👉 ถ้าไม่ใช่ admin ให้กรอง hospital
                        if (!userDb.data().isAdmin) {
                            opdQuery = opdQuery.where("location", "==", location);
                        }

                        opdQuery.get()
                            .then(opdSnapshot => {
                                if (!opdSnapshot) return;
                                /*opdSnapshot.forEach(doc => {
                                    console.log("พบ opdCard:", doc.id, doc.data());
                                });*/
                                let employeeData = {};
                                //employeeData.firstName = customerDb.data().firstName;
                                //employeeData.lastName = customerDb.data().lastName;
                                employeeData.employeeId = customerDb.data().employeeId;

                                /*if (opdSnapshot.size == 0) {
                                    //showNotification('warning', 'ไม่พบข้อมูล', `ไม่พบประวัติการรักษาของ ${employeeName}`);
                                    //recordDetail.classList.add('hidden');
                                    displayMedicalRecords(opdSnapshot, employeeData )
                                } else {
                                    //displayMedicalRecords
                                    displayMedicalRecords(opdSnapshot, employeeData)
                                }*/
                                displayMedicalRecords(opdSnapshot, employeeData)
                            })
                            .catch(error => {
                                console.error("เกิดข้อผิดพลาด:", error);
                            });

                        /*const employeeMedicalRecords = sampleData.employeeMedicalRecords[employeeId];
                        if (employeeMedicalRecords) {
                            const recordIds = Object.keys(employeeMedicalRecords);
                            const records = recordIds.map(id => sampleData.medicalRecords[id]);
                            // Sort records by visit date (newest first)
                            records.sort((a, b) => new Date(b.visitDate) - new Date(a.visitDate));
                            displayMedicalRecords(records, {
                                firstName: employeeName.split(' ')[0],
                                lastName: employeeName.split(' ')[1]
                            });
                        } else {
                            showNotification('warning', 'ไม่พบข้อมูล', `ไม่พบประวัติการรักษาของ ${employeeName}`);
                            recordDetail.classList.add('hidden');
                        }*/


                        hideLoading();
                    }, 800);
                });
            });
        }
        // Display Medical Records
        async function displayMedicalRecords(records, employeeData) {
            /*if (records.length === 0) {
                searchResults.innerHTML = `

                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-400"
                                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                      ไม่พบประวัติการรักษาของ ${employeeData.firstName} ${employeeData.lastName}
                    </p>
                        </div>
                    </div>
                </div>
`;
                recordDetail.classList.add('hidden');
                return;
            }*/
            /*let html = `

      <div class="mb-4 bg-turquoise-light rounded-lg p-4">
          <h3 class="font-medium text-navy">ข้อมูลพนักงาน: ${employeeData.firstName} ${employeeData.lastName}</h3>
          <p class="text-sm text-gray-600">รหัสพนักงาน: ${employeeData.employeeId}</p>
      </div>
      <div class="overflow-x-auto">
          <table class="min-w-full bg-white">
              <thead class="bg-gray-100">
                  <tr>
                      <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่รับบริการ</th>
                      <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">อาการสำคัญ</th>
                      <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ESI</th>
                      <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภทบริการ</th>
                      <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                  </tr>
              </thead>
              <tbody>
`;*/
            let html = `

                        <div class="mb-4  rounded-lg p-4" style="background-color: #cbf4f4">
                         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-1">
                        <h3 class="text-lg font-medium text-navy mb-3">ข้อมูลพนักงาน</h3>
                        <div class="mb-3"></div>
                        <div class="grid grid-cols-2 gap-1">
                        <div class="mb-3">
                            <label class="block text-gray-700 text-sm font-medium mb-1" for="employeeId3">
                                รหัสพนักงาน <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="employeeId3" name="employeeId3" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                        </div>
                        <div class="mb-3">
                            <label class="block text-gray-700 text-sm font-medium mb-1" for="department3">
                                แผนก 
                            </label>
                            <input type="text" id="department3" name="department3" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                        </div>
                        </div>
						<div class="grid grid-cols-2 gap-1">
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="birthdate3">วันเดือนปีเกิด</label>
                                <input type="date" id="birthdate3" name="birthdate3" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="phone3">เบอร์โทรศัพท์</label>
                                <input type="tel" id="phone3" name="phone3" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none">
                            </div>
                        </div>
						<!--
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="firstName3">
                                    ชื่อ <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="firstName3" name="firstName3" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="lastName3">
                                    นามสกุล <span class="text-red-500">*</span>
                                </label>
                                <input type="text" id="lastName3" name="lastName3" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                            </div>
                        </div>
						-->
                    </div>
					<!--
                    <div class="grid grid-cols-2 gap-1">
						
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-medium mb-1" for="department3">
                                แผนก 
                            </label>
                            <input type="text" id="department3" name="department3" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none" required>
                        </div>
						
                        <div class="grid grid-cols-2 gap-1">
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="birthdate3">วันเดือนปีเกิด</label>
                                <input type="date" id="birthdate3" name="birthdate3" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none">
                            </div>
                            <div class="mb-3">
                                <label class="block text-gray-700 text-sm font-medium mb-1" for="phone3">เบอร์โทรศัพท์</label>
                                <input type="tel" id="phone3" name="phone3" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none">
                            </div>
                        </div>
                    </div>
					-->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-1">
                        <div class="mb-3">
                            <label class="block text-gray-700 text-sm font-medium mb-1" for="congenitalDisease3">โรคประจำตัว</label>
                            <textarea id="congenitalDisease3" name="congenitalDisease3" rows="1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="block text-gray-700 text-sm font-medium mb-1" for="allergies3">แพ้ยา/แพ้อาหาร</label>
                            <textarea id="allergies3" name="allergies3" rows="1" class="form-input w-full px-3 py-2 border rounded-md focus:outline-none"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <button id="saveCustomerBtn3" onClick="saveCustomerBtn3()"  class="btn-primary px-6 py-2 rounded-md">บันทึกข้อมูล</button>
                        <button id="back2SearchBtn3" onClick="back2SearchBtn3()"  class="btn-danger ml-4 px-6 py-2 rounded-md">ย้อนกลับ</button>
                    </div>

                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่รับบริการ</th>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">อาการสำคัญ</th>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การวินิจฉัย</th>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                                    </tr>
                                </thead>
                                <tbody>
                  `;
            if (records.size == 0) {
                html += `<tr>  <td style="text-align: center;" class="py-2 px-4 border-b" colspan="4">ไม่พบประวัติการรักษาของ </td>  </tr>`;
            }

            records.forEach(record => {
                const visitDate = new Date(record.data().visitDate).toLocaleString('th-TH', {
                    dateStyle: 'medium',
                    timeStyle: 'short'
                });
                let serviceTypeText = '';
                /* switch (record.serviceType) {
                     case 'consulted':
                         serviceTypeText = 'ปรึกษาพยาบาล';
                         break;
                     case 'selfMedication':
                         serviceTypeText = 'สั่งจ่ายยาด้วยตนเอง';
                         break;
                     case 'observeRoom':
                         serviceTypeText = 'ใช้ห้องสังเกตอาการ';
                         break;
                     case 'emergency':
                         serviceTypeText = 'อุบัติเหตุ/ฉุกเฉิน';
                         break;
                     case 'refer':
                         serviceTypeText = 'ส่งต่อ/แนะนำ';
                         break;
                     default:
                         serviceTypeText = record.serviceType;
                 }*/
                serviceTypeText = record.data().serviceType;
                html += `

                        <tr>
                            <td class="py-2 px-4 border-b">${visitDate}</td>
                            <td class="py-2 px-4 border-b">${record.data().chiefComplaint}</td>
                            <td class="py-2 px-4 border-b">${record.data().diagnosis}</td>
                            <td class="py-2 px-4 border-b">
                                <button class="view-record-detail-btn text-white bg-navy hover:bg-blue-800 px-3 py-1 rounded-md text-sm" data-record-id="${record.id}">
                            รายละเอียด
                          </button>
                            </td>
                        </tr>
                    `;
            });
            html += `

                                </tbody>
                            </table>
                        </div>
                  `;
            searchResults.innerHTML = html;
            const decryptedValue = await decryptTextFnCached(customerDb.data().employeeId);
            document.getElementById('employeeId3').value = decryptedValue;
            /*document.getElementById('firstName3').value = customerDb.data().firstName;
            document.getElementById('lastName3').value = customerDb.data().lastName;*/
            document.getElementById('department3').value = customerDb.data().department;
            document.getElementById('birthdate3').value = customerDb.data().birthdate;
            document.getElementById('phone3').value = customerDb.data().phone;
            document.getElementById('allergies3').value = customerDb.data().allergies;
            document.getElementById('congenitalDisease3').value = customerDb.data().congenitalDisease;

            recordDetail.classList.add('hidden');
            // Add event listeners to view record detail buttons
            /*document.querySelectorAll('.view-record-detail-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = e.target.getAttribute('data-record-id');
                    const record = sampleData.medicalRecords[recordId];
                    if (record) {
                        displayRecordDetail(record);
                    }
                });
            });*/
            document.querySelectorAll('.view-record-detail-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const recordId = e.target.getAttribute('data-record-id');
                    records.forEach(record => {
                        if (recordId == record.id) {
                            displayRecordDetail(record);
                        }
                    });
                });
            });
        }
        // Display Record Detail
        function displayRecordDetail(record) {
            const visitDate = new Date(record.data().visitDate).toLocaleString('th-TH', {
                dateStyle: 'medium',
                timeStyle: 'short'
            });
            let serviceTypeText = '';
            /*switch (record.serviceType) {
                case 'consulted':
                    serviceTypeText = 'ปรึกษาพยาบาล';
                    break;
                case 'selfMedication':
                    serviceTypeText = 'สั่งจ่ายยาด้วยตนเอง';
                    break;
                case 'observeRoom':
                    serviceTypeText = 'ใช้ห้องสังเกตอาการ';
                    break;
                case 'emergency':
                    serviceTypeText = 'อุบัติเหตุ/ฉุกเฉิน';
                    break;
                case 'refer':
                    serviceTypeText = 'ส่งต่อ/แนะนำ';
                    break;
                default:
                    serviceTypeText = record.serviceType;
            }*/
            serviceTypeText = record.data().serviceType;
            let followUpText = record.data().followUp === 'Y' ? 'มี' : 'ไม่มี';
            const createdDate = record.data().createdDate.toDate();
            createdDate.setHours(createdDate.getHours() + 7);
            let meds = '<p class="mt-1 bg-white p-2 rounded border">-</p>';
            if (record.data().medicines?.length > 0) {
                meds = '';
                
                for (let i = 0; i < record.data().medicines.length; ++i) {
                    let note = '';
                    if (record.data().medicines[i].note != '') {
                        note = ' (' + record.data().medicines[i].note + ')';
                    }
                    meds += `<p class="mt-1 bg-white p-2 rounded border">${(i+1) + '. ' + record.data().medicines[i].name + ' ' + record.data().medicines[i].quantity + ' ' + record.data().medicines[i].unit + note || '-'}</p>`;
                }
            }
            let html = `

                        <div class="bg-gray-50 rounded-lg p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-medium text-navy mb-3">ข้อมูลการรับบริการ</h4>
                                    <div class="space-y-2">
                                        <div class="flex">
                                            <span class="font-medium w-32">วันที่รับบริการ:</span>
                                            <span>${visitDate}</span>
                                        </div>
                                        <div class="flex">
                                            <span class="font-medium w-32">Location:</span>
                                            <span>${record.data().location}</span>
                                        </div>
                                        <div class="flex">
                                            <span class="font-medium w-32">ESI Triage:</span>
                                            <span>${record.data().esiTriage}</span>
                                        </div>
                                        <div class="flex">
                                            <span class="font-medium w-32">ประเภทบริการ:</span>
                                            <span>${serviceTypeText}</span>
                                        </div>
                                        <div class="flex">
                                            <span class="font-medium w-32">การนัดติดตาม:</span>
                                            <span>${followUpText}</span>
                                        </div>
                                    </div>
                                    <h4 class="font-medium text-navy mt-6 mb-3">Vital Signs</h4>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div class="flex">
                                            <span class="font-medium w-32">อุณหภูมิ:</span>
                                            <span>${record.data().temperature || '-'} °C</span>
                                        </div>
                                        <div class="flex">
                                            <span class="font-medium w-32">ชีพจร:</span>
                                            <span>${record.data().pulse || '-'} ครั้ง/นาที</span>
                                        </div>
                                        <div class="flex">
                                            <span class="font-medium w-32">การหายใจ:</span>
                                            <span>${record.data().respiration || '-'} ครั้ง/นาที</span>
                                        </div>
                                        <div class="flex">
                                            <span class="font-medium w-32">ความดันโลหิต:</span>
                                            <span>${record.data().bloodPressure || '-'} mmHg</span>
                                        </div>
                                        <div class="flex">
                                            <span class="font-medium w-32">SpO2:</span>
                                            <span>${record.data().oxygenSaturation || '-'} %</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-medium text-navy mb-3">ข้อมูลการรักษา</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <p class="font-medium text-navy">อาการสำคัญ</p>
                                            <p class="mt-1 bg-white p-2 rounded border">${record.data().chiefComplaint || '-'}</p>
                                        </div>
                                        <div>
                                            <p class="font-medium text-navy">การตรวจร่างกาย</p>
                                            <p class="mt-1 bg-white p-2 rounded border">${record.data().physicalExamination || '-'}</p>
                                        </div>
                                        <div>
                                            <p class="font-medium text-navy">การวินิจฉัย</p>
                                            <p class="mt-1 bg-white p-2 rounded border">${record.data().diagnosis || '-'}</p>
                                        </div>
                                        <div>
                                            <p class="font-medium text-navy">การรักษา/ยาที่ให้</p>
                                           ${meds}
                                        </div>
                                        <div>
                                            <p class="font-medium text-navy">คำแนะนำ</p>
                                            <p class="mt-1 bg-white p-2 rounded border">${record.data().advice || '-'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 text-right">
                                <p class="text-sm text-gray-500">บันทึกโดย: ${record.data().createdBy || '-'}</p>
                                <p class="text-sm text-gray-500">เวลาที่บันทึก: ${new Date(createdDate.toISOString().slice(0, 16)).toLocaleString('th-TH')}</p>
                            </div>
                            <div class="mt-6 flex justify-center hidden">
                                <button id="printRecordBtn" class="btn-secondary px-6 py-2 rounded-md flex items-center">
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                    </svg>
                          พิมพ์ประวัติ

                            </button>
                        </div>
                    </div>
                  `;
            recordDetailContent.innerHTML = html;
            recordDetail.classList.remove('hidden');
            // Add event listener to print button
            document.getElementById('printRecordBtn').addEventListener('click', () => {
                showNotification('info', 'การพิมพ์', 'กำลังเตรียมข้อมูลสำหรับการพิมพ์...');
            });
        }
        let editingIndex = -1;
        let medicines = [
            /*{
                name: 'พาราเซตามอล',
                type: 'ยาแก้ปวด',
                quantity: 50,
                unit: 'เม็ด',
                note: 'สำหรับแก้ปวดหัว'
            },
            {
                name: 'แอสไพริน',
                type: 'ยาแก้ไข้',
                quantity: 30,
                unit: 'เม็ด',
                note: 'ลดไข้และแก้ปวด'
            }*/
        ];
        function getTypeColor(type) {
            const colors = {
                'ยาแก้ปวด': 'bg-blue-100 text-blue-800',
                'ยาแก้ไข้': 'bg-green-100 text-green-800',
                'ยาปฏิชีวนะ': 'bg-red-100 text-red-800',
                'ยาแก้แพ้': 'bg-yellow-100 text-yellow-800',
                'ยาวิตามิน': 'bg-purple-100 text-purple-800',
                'อื่นๆ': 'bg-gray-100 text-gray-800'
            };
            return colors[type] || 'bg-gray-100 text-gray-800';
        }
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingIndex = -1;
        }

        function deleteMedicine(index) {
            if (confirm('คุณต้องการลบยานี้ใช่หรือไม่?')) {
                medicines.splice(index, 1);
                renderTable();
            }
        }
        function saveEdit(index) {

            if (!document.getElementById('editMedicineName').value) {
                showNotification('error', 'ข้อผิดพลาด', 'กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน');
                return;
            }
            //if (editingIndex === -1) return;
            if (editingIndex === -1) {
                const name = document.getElementById('editMedicineName').value;
                const type = document.getElementById('editMedicineType').value;
                const quantity = parseInt(document.getElementById('editMedicineQuantity').value) || 0;
                const unit = document.getElementById('editMedicineUnit').value;
                const note = document.getElementById('editMedicineNote').value.trim();

                medicines.push({
                    name,
                    type,
                    quantity,
                    unit,
                    note
                });

                closeEditModal();
                renderTable();
            } else {
                const name = document.getElementById('editMedicineName').value;
                const type = document.getElementById('editMedicineType').value;
                const quantity = parseInt(document.getElementById('editMedicineQuantity').value) || 0;
                const unit = document.getElementById('editMedicineUnit').value;
                const note = document.getElementById('editMedicineNote').value.trim();

                if (!name || !type || !unit) {
                    alert('กรุณากรอกข้อมูลให้ครบถ้วน (ชื่อยา, ประเภท, หน่วย)');
                    return;
                }

                medicines[editingIndex] = {
                    name,
                    type,
                    quantity,
                    unit,
                    note
                };

                closeEditModal();
                renderTable();
            }
        }
        function clearMed(){
            nameChoices.removeActiveItems();
            nameChoices.clearChoices();

            unitSelect.innerHTML = '<option>-- เลือก --</option>';

            typeSelect.innerHTML = "";
            nameSelect.innerHTML = "";
            const defaultOption = document.createElement("option");
            defaultOption.textContent = "-- เลือก --";
            defaultOption.value = '';        // หรือ "none"
            //defaultOption.disabled = true;
            defaultOption.selected = true;
            typeSelect.appendChild(defaultOption);

            uniqueTypes.forEach(type => {
                const opt = document.createElement("option");
                opt.value = opt.textContent = type;
                typeSelect.appendChild(opt);
            });

            uniqueUnit.forEach(type => {
                const opt = document.createElement("option");
                opt.value = opt.textContent = type;
                unitSelect.appendChild(opt);
            });

            const defaultChoice = { value: '', label: '-- เลือก --', disabled: true, selected: true };
            nameChoices.setChoices(
                [defaultChoice,
                ...uniqueNames.map(n => ({ value: n, label: n }))],
                'value', 'label', true
            );
        }
        function addMedicine() {
            document.getElementById('editMedicineName').value = '';
            document.getElementById('editMedicineType').value = '';
            document.getElementById('editMedicineQuantity').value = '';
            document.getElementById('editMedicineUnit').value = '';
            document.getElementById('editMedicineNote').value = '';

            document.getElementById('editModal').classList.remove('hidden');

            clearMed();
        }
        function editMedicine(index) {

            editingIndex = index;
            const medicine = medicines[index];

            clearMed();

            nameChoices.setChoiceByValue(medicine.name);
            //document.getElementById('editMedicineName').value = medicine.name;
            document.getElementById('editMedicineType').value = medicine.type;
            document.getElementById('editMedicineQuantity').value = medicine.quantity;
            document.getElementById('editMedicineUnit').value = medicine.unit;
            document.getElementById('editMedicineNote').value = medicine.note || '';

            document.getElementById('editModal').classList.remove('hidden');
        }
        function renderTable() {
            const tbody = document.getElementById('medicineTableBody');
            const emptyState = document.getElementById('emptyState');
            const table = tbody.closest('.bg-white');

            if (medicines.length === 0) {
                table.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            table.classList.remove('hidden');
            emptyState.classList.add('hidden');

            tbody.innerHTML = medicines.map((medicine, index) => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${medicine.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getTypeColor(medicine.type)}">${medicine.type}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${medicine.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${medicine.unit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${medicine.note || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editMedicine(${index})" class="text-indigo-600 hover:text-indigo-900 mr-3 transition-colors duration-200">✏️ แก้ไข</button>
                            <button onclick="deleteMedicine(${index})" class="text-red-600 hover:text-red-900 transition-colors duration-200">🗑️ ลบ</button>
                        </td>
                    </tr>
                `).join('');
        }
        renderTable();
        // Generate Report
        generateReportBtn.addEventListener('click', () => {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const location = document.getElementById('locationReport').value;
            //let ret = countAllServiceTypeByDate(startDate, endDate + 'T23:59:59', location);
            //console.log(ret)
            if (!startDate || !endDate) {
                showNotification('error', 'ข้อผิดพลาด', 'กรุณาเลือกช่วงเวลาที่ต้องการ');
                return;
            }
            showLoading('กำลังสร้างรายงาน...');
            // Simulate API call with timeout
            setTimeout(() => {
                // Convert dates to timestamp for comparison
                const startTimestamp = new Date(startDate).getTime();
                const endTimestamp = new Date(endDate + 'T23:59:59').getTime();
                // Filter records by date range
                const filteredRecords = Object.values(sampleData.medicalRecords).filter(record => {
                    const recordDate = new Date(record.visitDate).getTime();
                    return recordDate >= startTimestamp && recordDate <= endTimestamp;
                });
                // Generate report based on type
                switch (reportType) {
                    case 'daily':
                        generateDailyReport(filteredRecords, startDate, endDate);
                        break;
                    case 'monthly':
                        generateMonthlyReport(filteredRecords, startDate, endDate);
                        break;
                    case 'serviceType':
                        //generateServiceTypeReport(filteredRecords, startDate, endDate);
                        generateServiceTypeReport(startDate, endDate + 'T23:59:59', location);
                        break;
                    case 'department':
                        //generateDepartmentReport(filteredRecords, startDate, endDate);
                        generateDiagnosisReport(startDate, endDate + 'T23:59:59', location, 'department');
                        break;
                    case 'diagnosis':
                        generateDiagnosisReport(startDate, endDate + 'T23:59:59', location, 'diagnosis');
                        break;
                    case 'medicine':
                        generateDiagnosisReport(startDate, endDate + 'T23:59:59', location, 'medicine');
                        break;
                }
                hideLoading();
            }, 1000);
        });

        async function countAllServiceTypeByDate(startDate, endDate, location) {
            const userData = userDb.data();
       
            let opdCardsQuery = db.collectionGroup("opdCard")
                .where("visitDate", ">=", startDate)
                .where("visitDate", "<=", endDate);

            if (!userData.isAdmin) {
                opdCardsQuery = opdCardsQuery.where("location", "==", userData.location);
            } else if (location !== '') {
                opdCardsQuery = opdCardsQuery.where("location", "==", location);
            }

            const serviceTypeCount = {};

            try {
                const snapshot = await opdCardsQuery.get();

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const type = data.serviceType || "ไม่ระบุ";

                    serviceTypeCount[type] = (serviceTypeCount[type] || 0) + 1;
                });

                //console.log(serviceTypeCount);
                const resultArray = Object.entries(serviceTypeCount).map(([name, qty]) => ({
                    name,
                    qty
                }));
                console.log(resultArray);
                return resultArray;

            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการ query:", error);
                return {};
            }
        }

        async function countAllDiagnosisByDate(startDate, endDate, location) {
            const userData = userDb.data();

            let opdCardsQuery = db.collectionGroup("opdCard")
                .where("visitDate", ">=", startDate)
                .where("visitDate", "<=", endDate);

            if (!userData.isAdmin) {
                opdCardsQuery = opdCardsQuery.where("location", "==", userData.location);
            } else if (location !== '') {
                opdCardsQuery = opdCardsQuery.where("location", "==", location);
            }

            const serviceTypeCount = {};

            try {
                const snapshot = await opdCardsQuery.get();

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const type = data.diagnosis || "ไม่ระบุ";

                    serviceTypeCount[type] = (serviceTypeCount[type] || 0) + 1;
                });

                //console.log(serviceTypeCount);
                const resultArray = Object.entries(serviceTypeCount).map(([name, qty]) => ({
                    name,
                    qty
                }));
                console.log(resultArray);
                return resultArray;

            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการ query:", error);
                return {};
            }
        }
        async function countAllMedicineNameByDate(startDate, endDate, location) {
            const userData = userDb.data();

            let opdCardsQuery = db.collectionGroup("opdCard")
                .where("visitDate", ">=", startDate)
                .where("visitDate", "<=", endDate);

            if (!userData.isAdmin) {
                opdCardsQuery = opdCardsQuery.where("location", "==", userData.location);
            } else if (location !== '') {
                opdCardsQuery = opdCardsQuery.where("location", "==", location);
            }

            const serviceTypeCount = {};

            try {
                const snapshot = await opdCardsQuery.get();

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log(data)
                    const meds = data.medicines || [];

                    meds.forEach((med) => {
                        const name = med.name + " (" + med.unit + ")" || "ไม่ระบุ";
               
                        serviceTypeCount[name] = (serviceTypeCount[name] || 0) + (med.quantity || 0);
                    });
                });

                console.log(serviceTypeCount);
                const resultArray = Object.entries(serviceTypeCount).map(([name, qty]) => ({
                    name,
                    qty
                }));
                console.log(resultArray);
                return resultArray;

            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการ query:", error);
                return {};
            }         
        }
        async function countAllOpdCardByDepartment(startDate, endDate, location) {
            const userData = userDb.data();

            const employeeSnapshot = await db.collection("employees").get();
            const departmentCount = {};

            for (const empDoc of employeeSnapshot.docs) {
                const employee = empDoc.data();
                const department = employee.department || "ไม่ระบุ";

                let opdCardQuery = db
                    .collection("employees")
                    .doc(empDoc.id)
                    .collection("opdCard")
                    .where("visitDate", ">=", startDate)
                    .where("visitDate", "<=", endDate);

                if (!userData.isAdmin) {
                    opdCardsQuery = opdCardsQuery.where("location", "==", userData.location);
                } else if (location !== '') {
                    opdCardsQuery = opdCardsQuery.where("location", "==", location);
                }

                const opdCardSnapshot = await opdCardQuery.get();

                const count = opdCardSnapshot.size;

                departmentCount[department] = (departmentCount[department] || 0) + count;
            }

            console.log(departmentCount);
            let resultArray = Object.entries(departmentCount).map(([name, qty]) => ({
                name,
                qty
            }));
            resultArray = resultArray.filter(item => item.qty !== 0);
            console.log(resultArray);
            return resultArray;
        }
        // Generate Daily Report
        function generateDailyReport(records, startDate, endDate) {
            // Group records by date
            const recordsByDate = {};
            records.forEach(record => {
                const date = new Date(record.visitDate).toLocaleDateString('th-TH', {
                    dateStyle: 'medium'
                });
                if (!recordsByDate[date]) {
                    recordsByDate[date] = [];
                }
                recordsByDate[date].push(record);
            });
            // Sort dates
            const sortedDates = Object.keys(recordsByDate).sort((a, b) => {
                return new Date(a) - new Date(b);
            });
            let html = `

                                                                                                                        <h3 class="text-lg font-medium text-navy mb-4">รายงานประจำวัน</h3>
                                                                                                                        <p class="mb-4">ช่วงวันที่: ${new Date(startDate).toLocaleDateString('th-TH', { dateStyle: 'medium' })} - ${new Date(endDate).toLocaleDateString('th-TH', { dateStyle: 'medium' })}</p>
                                                                                                                        <div class="overflow-x-auto">
                                                                                                                            <table class="min-w-full bg-white">
                                                                                                                                <thead class="bg-gray-100">
                                                                                                                                    <tr>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนผู้รับบริการ</th>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ESI 1</th>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ESI 2</th>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ESI 3</th>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ESI 4</th>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ESI 5</th>
                                                                                                                                    </tr>
                                                                                                                                </thead>
                                                                                                                                <tbody>
                  `;
            let totalRecords = 0;
            let totalESI1 = 0;
            let totalESI2 = 0;
            let totalESI3 = 0;
            let totalESI4 = 0;
            let totalESI5 = 0;
            const chartLabels = [];
            const chartData = [];
            sortedDates.forEach(date => {
                const dateRecords = recordsByDate[date];
                const count = dateRecords.length;
                totalRecords += count;
                // Count ESI levels
                const esi1 = dateRecords.filter(r => r.esiTriage === '1').length;
                const esi2 = dateRecords.filter(r => r.esiTriage === '2').length;
                const esi3 = dateRecords.filter(r => r.esiTriage === '3').length;
                const esi4 = dateRecords.filter(r => r.esiTriage === '4').length;
                const esi5 = dateRecords.filter(r => r.esiTriage === '5').length;
                totalESI1 += esi1;
                totalESI2 += esi2;
                totalESI3 += esi3;
                totalESI4 += esi4;
                totalESI5 += esi5;
                chartLabels.push(date);
                chartData.push(count);
                html += `

                                                                                                                                    <tr>
                                                                                                                                        <td class="py-2 px-4 border-b">${date}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${count}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${esi1}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${esi2}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${esi3}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${esi4}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${esi5}</td>
                                                                                                                                    </tr>
                    `;
            });
            html += `

                                                                                                                                    <tr class="bg-gray-100 font-medium">
                                                                                                                                        <td class="py-2 px-4 border-b">รวม</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${totalRecords}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${totalESI1}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${totalESI2}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${totalESI3}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${totalESI4}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${totalESI5}</td>
                                                                                                                                    </tr>
                                                                                                                                </tbody>
                                                                                                                            </table>
                                                                                                                        </div>
                  `;
            reportResults.innerHTML = html;
            // Create chart
            createChart('bar', 'จำนวนผู้รับบริการรายวัน', chartLabels, chartData);
        }
        // Generate Monthly Report
        function generateMonthlyReport(records, startDate, endDate) {
            // Group records by month
            const recordsByMonth = {};
            records.forEach(record => {
                const date = new Date(record.visitDate);
                const month = date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long'
                });
                if (!recordsByMonth[month]) {
                    recordsByMonth[month] = [];
                }
                recordsByMonth[month].push(record);
            });
            // Sort months
            const sortedMonths = Object.keys(recordsByMonth).sort((a, b) => {
                return new Date(a) - new Date(b);
            });
            let html = `

                                                                                                                        <h3 class="text-lg font-medium text-navy mb-4">รายงานประจำเดือน</h3>
                                                                                                                        <p class="mb-4">ช่วงวันที่: ${new Date(startDate).toLocaleDateString('th-TH', { dateStyle: 'medium' })} - ${new Date(endDate).toLocaleDateString('th-TH', { dateStyle: 'medium' })}</p>
                                                                                                                        <div class="overflow-x-auto">
                                                                                                                            <table class="min-w-full bg-white">
                                                                                                                                <thead class="bg-gray-100">
                                                                                                                                    <tr>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เดือน</th>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนผู้รับบริการ</th>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ปรึกษาพยาบาล</th>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สั่งจ่ายยาด้วยตนเอง</th>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ใช้ห้องสังเกตอาการ</th>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">อุบัติเหตุ/ฉุกเฉิน</th>
                                                                                                                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ส่งต่อ/แนะนำ</th>
                                                                                                                                    </tr>
                                                                                                                                </thead>
                                                                                                                                <tbody>
                  `;
            let totalRecords = 0;
            let totalConsulted = 0;
            let totalSelfMedication = 0;
            let totalObserveRoom = 0;
            let totalEmergency = 0;
            let totalRefer = 0;
            const chartLabels = [];
            const chartData = [];
            sortedMonths.forEach(month => {
                const monthRecords = recordsByMonth[month];
                const count = monthRecords.length;
                totalRecords += count;
                // Count service types
                const consulted = monthRecords.filter(r => r.serviceType === 'consulted').length;
                const selfMedication = monthRecords.filter(r => r.serviceType === 'selfMedication').length;
                const observeRoom = monthRecords.filter(r => r.serviceType === 'observeRoom').length;
                const emergency = monthRecords.filter(r => r.serviceType === 'emergency').length;
                const refer = monthRecords.filter(r => r.serviceType === 'refer').length;
                totalConsulted += consulted;
                totalSelfMedication += selfMedication;
                totalObserveRoom += observeRoom;
                totalEmergency += emergency;
                totalRefer += refer;
                chartLabels.push(month);
                chartData.push(count);
                html += `

                                                                                                                                    <tr>
                                                                                                                                        <td class="py-2 px-4 border-b">${month}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${count}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${consulted}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${selfMedication}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${observeRoom}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${emergency}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${refer}</td>
                                                                                                                                    </tr>
                    `;
            });
            html += `

                                                                                                                                    <tr class="bg-gray-100 font-medium">
                                                                                                                                        <td class="py-2 px-4 border-b">รวม</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${totalRecords}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${totalConsulted}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${totalSelfMedication}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${totalObserveRoom}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${totalEmergency}</td>
                                                                                                                                        <td class="py-2 px-4 border-b">${totalRefer}</td>
                                                                                                                                    </tr>
                                                                                                                                </tbody>
                                                                                                                            </table>
                                                                                                                        </div>
                  `;
            reportResults.innerHTML = html;
            // Create chart
            createChart('bar', 'จำนวนผู้รับบริการรายเดือน', chartLabels, chartData);
        }
        async function generateDiagnosisReport(startDate, endDate, location, mode) {
            // Group records by service type
            let records = [];
            let h1 = '';
            let h2 = '';
            let h3 = '';
            if (mode == 'diagnosis') {
                h1 = 'รายงานตามประเภทการวินิฉฉัย';
                h2 = 'ประเภทการวินิฉฉัย';
                h3 = 'สัดส่วนประเภทการวินิฉฉัย';
                records = await countAllDiagnosisByDate(startDate, endDate, location);
            } else if (mode == 'medicine') {
                h1 = 'รายงานตามการใช้ยา';
                h2 = 'การใช้ยา';
                h3 = 'สัดส่วนการใช้ยา';
                records = await countAllMedicineNameByDate(startDate, endDate, location);
            } else if (mode == 'department') {
                h1 = 'รายงานตามแผนก';
                h2 = 'แผนก';
                h3 = 'สัดส่วนตามแผนก';
                records = await countAllOpdCardByDepartment(startDate, endDate, location);
            }
            let html = `

                <h3 class="text-lg font-medium text-navy mb-4">${h1}</h3>
                <p class="mb-4">ช่วงวันที่: ${new Date(startDate).toLocaleDateString('th-TH', { dateStyle: 'medium' })} - ${new Date(endDate).toLocaleDateString('th-TH', { dateStyle: 'medium' })}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h2}</th>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวน</th>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ร้อยละ</th>
                                    </tr>
                                </thead>
                                <tbody>
                  `;
            //const totalCount = records.length;
            const totalCount = records.reduce((sum, item) => sum + item.qty, 0);
            let totalPercentage = 0;
            const chartLabels = [];
            const chartData = [];
            const chartColors = ['rgba(54, 162, 235, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(255, 206, 86, 0.8)', 'rgba(255, 99, 132, 0.8)', 'rgba(153, 102, 255, 0.8)'];
            //Object.keys(records).forEach((type, index) => {
            records.forEach((type, index) => {
                /*const {
                    name,
                    count
                } = serviceTypes[type];*/
                console.log(type)
                const count = type.qty;
                const name = type.name;
                const percentage = totalCount > 0 ? (count / totalCount * 100).toFixed(2) : 0;
                totalPercentage += parseFloat(percentage);
                chartLabels.push(name);
                chartData.push(count);
                html += `

                                <tr>
                                    <td class="py-2 px-4 border-b">${name}</td>
                                    <td class="py-2 px-4 border-b">${count}</td>
                                    <td class="py-2 px-4 border-b">${percentage}%</td>
                                </tr>
`;
            });
            html += `

                                    <tr class="bg-gray-100 font-medium">
                                        <td class="py-2 px-4 border-b">รวม</td>
                                        <td class="py-2 px-4 border-b">${totalCount}</td>
                                        <td class="py-2 px-4 border-b">${totalPercentage.toFixed(2)}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                  `;
            reportResults.innerHTML = html;
            // Create chart
            createChart('pie', h3, chartLabels, chartData, chartColors);
        }
        // Generate Service Type Report
        //function generateServiceTypeReport(records, startDate, endDate) {
        async function generateServiceTypeReport(startDate, endDate, location) {
            // Group records by service type
            let records = await countAllServiceTypeByDate(startDate, endDate, location);
           
            /*const serviceTypes = {
                consulted: {
                    name: 'ปรึกษาพยาบาล',
                    count: 0
                },
                selfMedication: {
                    name: 'สั่งจ่ายยาด้วยตนเอง',
                    count: 0
                },
                observeRoom: {
                    name: 'ใช้ห้องสังเกตอาการ',
                    count: 0
                },
                emergency: {
                    name: 'อุบัติเหตุ/ฉุกเฉิน',
                    count: 0
                },
                refer: {
                    name: 'ส่งต่อ/แนะนำ',
                    count: 0
                }
            };
            records.forEach(record => {
                if (serviceTypes[record.serviceType]) {
                    serviceTypes[record.serviceType].count++;
                }
            });
            console.log(serviceTypes)*/
            let html = `

                <h3 class="text-lg font-medium text-navy mb-4">รายงานตามประเภทการให้บริการ</h3>
                <p class="mb-4">ช่วงวันที่: ${new Date(startDate).toLocaleDateString('th-TH', { dateStyle: 'medium' })} - ${new Date(endDate).toLocaleDateString('th-TH', { dateStyle: 'medium' })}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภทการให้บริการ</th>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวน</th>
                                        <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ร้อยละ</th>
                                    </tr>
                                </thead>
                                <tbody>
                  `;
            //const totalCount = records.length;
            const totalCount = records.reduce((sum, item) => sum + item.qty, 0);
            let totalPercentage = 0;
            const chartLabels = [];
            const chartData = [];
            const chartColors = ['rgba(54, 162, 235, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(255, 206, 86, 0.8)', 'rgba(255, 99, 132, 0.8)', 'rgba(153, 102, 255, 0.8)'];
            //Object.keys(records).forEach((type, index) => {
            records.forEach((type, index) => {
                /*const {
                    name,
                    count
                } = serviceTypes[type];*/
                console.log(type)
                const count = type.qty;
                const name = type.name;
                const percentage = totalCount > 0 ? (count / totalCount * 100).toFixed(2) : 0;
                totalPercentage += parseFloat(percentage);
                chartLabels.push(name);
                chartData.push(count);
                html += `

                                <tr>
                                    <td class="py-2 px-4 border-b">${name}</td>
                                    <td class="py-2 px-4 border-b">${count}</td>
                                    <td class="py-2 px-4 border-b">${percentage}%</td>
                                </tr>
`;
            });
            html += `

                                    <tr class="bg-gray-100 font-medium">
                                        <td class="py-2 px-4 border-b">รวม</td>
                                        <td class="py-2 px-4 border-b">${totalCount}</td>
                                        <td class="py-2 px-4 border-b">${totalPercentage.toFixed(2)}%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                  `;
            reportResults.innerHTML = html;
            // Create chart
            createChart('pie', 'สัดส่วนประเภทการให้บริการ', chartLabels, chartData, chartColors);
        }
        // Generate Department Report
        function generateDepartmentReport(records, startDate, endDate) {
            // Group records by department
            const recordsByDepartment = {};
            records.forEach(record => {
                const employeeId = record.employeeId;
                const employee = sampleData.employees[employeeId];
                if (employee && employee.department) {
                    const department = employee.department;
                    if (!recordsByDepartment[department]) {
                        recordsByDepartment[department] = [];
                    }
                    recordsByDepartment[department].push(record);
                }
            });
            // Sort departments by count
            const sortedDepartments = Object.keys(recordsByDepartment).sort((a, b) => {
                return recordsByDepartment[b].length - recordsByDepartment[a].length;
            });
            let html = `

                                                                                                                        <h3 class="text-lg font-medium text-navy mb-4">รายงานตามแผนก</h3>
                                                                                                                        <p class="mb-4">ช่วงวันที่: ${new Date(startDate).toLocaleDateString('th-TH', { dateStyle: 'medium' })} - ${new Date(endDate).toLocaleDateString('th-TH', { dateStyle: 'medium' })}</p>
                                                                                                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                                                                                            <div>
                                                                                                                                <div class="overflow-x-auto">
                                                                                                                                    <table class="min-w-full bg-white">
                                                                                                                                        <thead class="bg-gray-100">
                                                                                                                                            <tr>
                                                                                                                                                <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">แผนก</th>
                                                                                                                                                <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวน</th>
                                                                                                                                                <th class="py-2 px-4 border-b text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ร้อยละ</th>
                                                                                                                                            </tr>
                                                                                                                                        </thead>
                                                                                                                                        <tbody>
                  `;
            const totalCount = records.length;
            let totalPercentage = 0;
            const chartLabels = [];
            const chartData = [];
            const chartColors = ['rgba(54, 162, 235, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(255, 206, 86, 0.8)', 'rgba(255, 99, 132, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)', 'rgba(201, 203, 207, 0.8)'];
            sortedDepartments.forEach((department, index) => {
                const departmentRecords = recordsByDepartment[department];
                const count = departmentRecords.length;
                const percentage = totalCount > 0 ? (count / totalCount * 100).toFixed(2) : 0;
                totalPercentage += parseFloat(percentage);
                chartLabels.push(department);
                chartData.push(count);
                html += `

                                                                                                                                            <tr>
                                                                                                                                                <td class="py-2 px-4 border-b">${department}</td>
                                                                                                                                                <td class="py-2 px-4 border-b">${count}</td>
                                                                                                                                                <td class="py-2 px-4 border-b">${percentage}%</td>
                                                                                                                                            </tr>
                    `;
            });
            html += `

                                                                                                                                            <tr class="bg-gray-100 font-medium">
                                                                                                                                                <td class="py-2 px-4 border-b">รวม</td>
                                                                                                                                                <td class="py-2 px-4 border-b">${totalCount}</td>
                                                                                                                                                <td class="py-2 px-4 border-b">${totalPercentage.toFixed(2)}%</td>
                                                                                                                                            </tr>
                                                                                                                                        </tbody>
                                                                                                                                    </table>
                                                                                                                                </div>
                                                                                                                            </div>
                                                                                                                        </div>
                  `;
            reportResults.innerHTML = html;
            // Create chart
            createChart('doughnut', 'สัดส่วนการรับบริการตามแผนก', chartLabels, chartData, chartColors);
        }
        // Create Chart
        function createChart(type, title, labels, data, colors = null) {
            // Destroy previous chart if exists
            if (myChart) {
                myChart.destroy();
            }
            // Show chart canvas
            reportChart.classList.remove('hidden');
            // Create chart
            const ctx = reportChart.getContext('2d');
            const chartColors = colors || ['rgba(54, 162, 235, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(255, 206, 86, 0.8)', 'rgba(255, 99, 132, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)', 'rgba(201, 203, 207, 0.8)'];
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 16
                        }
                    }
                }
            };
            if (type === 'bar') {
                chartOptions.scales = {
                    y: {
                        beginAtZero: true
                    }
                };
            }
            const chartConfig = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'จำนวน',
                        data: data,
                        backgroundColor: type === 'bar' ? 'rgba(64, 224, 208, 0.8)' : chartColors,
                        borderColor: type === 'bar' ? 'rgba(64, 224, 208, 1)' : chartColors.map(color => color.replace('0.8', '1')),
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            };
            myChart = new Chart(ctx, chartConfig);
        }
        // Show Notification
        function showNotification(type, title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            // Set icon and color based on type
            switch (type) {
                case 'success':
                    notificationIcon.className = 'flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3 bg-green-100 text-green-500';
                    notificationIcon.innerHTML = `

                                                                                                                        <svg class="h-5 w-5"
                                                                                                                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                                                                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                                                                                                        </svg>
                      `;
                    break;
                case 'error':
                    notificationIcon.className = 'flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3 bg-red-100 text-red-500';
                    notificationIcon.innerHTML = `

                                                                                                                        <svg class="h-5 w-5"
                                                                                                                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                                                                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                                                                                                        </svg>
                      `;
                    break;
                case 'warning':
                    notificationIcon.className = 'flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3 bg-yellow-100 text-yellow-500';
                    notificationIcon.innerHTML = `

                                                                                                                        <svg class="h-5 w-5"
                                                                                                                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                                                                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                                                                                        </svg>
                      `;
                    break;
                default:
                    notificationIcon.className = 'flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3 bg-blue-100 text-blue-500';
                    notificationIcon.innerHTML = `

                                                                                                                        <svg class="h-5 w-5"
                                                                                                                            xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                                                                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                                                                                        </svg>
                      `;
            }
            // Show notification
            notification.classList.remove('scale-0');
            notification.classList.add('scale-100');
            // Auto hide after 5 seconds
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }
        // Hide Notification
        function hideNotification() {
            notification.classList.remove('scale-100');
            notification.classList.add('scale-0');
        }
        // Close Notification Button
        closeNotification.addEventListener('click', hideNotification);
        // Show Loading Overlay
        function showLoading(message = 'กำลังประมวลผล...') {
            loadingMessage.textContent = message;
            loadingOverlay.classList.remove('hidden');
        }
        // Hide Loading Overlay
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }
    </script>
    <script>
        (function () {
            function c() {
                var b = a.contentDocument || a.contentWindow.document;
                if (b) {
                    var d = b.createElement('script');
                    d.innerHTML = "window.__CF$cv$params={r:'963bef58609c14aa',t:'MTc1MzI4MTY0Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
                    b.getElementsByTagName('head')[0].appendChild(d)
                }
            }
            if (document.body) {
                var a = document.createElement('iframe');
                a.height = 1;
                a.width = 1;
                a.style.position = 'absolute';
                a.style.top = 0;
                a.style.left = 0;
                a.style.border = 'none';
                a.style.visibility = 'hidden';
                document.body.appendChild(a);
                if ('loading' !== document.readyState) c();
                else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c);
                else {
                    var e = document.onreadystatechange || function () { };
                    document.onreadystatechange = function (b) {
                        e(b);
                        'loading' !== document.readyState && (document.onreadystatechange = e, c())
                    }
                }
            }
        })();
    </script>
</body>
</html>
